<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Nexus Network</title>
    <link rel="icon" href="https://via.placeholder.com/32/00EEFF/004D40?text=QN" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* Global Styles */
        :root {
            --primary-color: #00EEFF; /* Neon Mavi */
            --secondary-color: #004D40; /* Koyu Deniz Yeşili */
            --background-dark: #0A0A0A;
            --text-light: #E0E0E0;
            --error-red: #FF4136;
            --success-green: #2ECC40;
            --border-glow: rgba(0, 238, 255, 0.6);
            --box-shadow-glow: 0 0 15px var(--border-glow);
            --modal-bg: rgba(0, 0, 0, 0.85);
            --input-border: #006D60;
            --input-focus-glow: 0 0 12px rgba(0, 238, 255, 0.8);
            --notification-bg: #4A0050; /* Mor tonu */
            --notification-border: #FF00FF; /* Mor neon */
            --warning-red: #FF0000; /* Uyarı Kırmızısı */
            --warning-glow: rgba(255, 0, 0, 0.8);
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: var(--background-dark);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            position: relative; /* For loading screen and particles */
        }

        /* Particle Background */
        #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 1;
            background-color: var(--background-dark);
        }

        .container {
            background-color: #1A1A1A;
            border: 2px solid var(--secondary-color);
            border-radius: 12px;
            box-shadow: var(--box-shadow-glow);
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 10;
        }

        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #000000 0%, #001a1a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transform: scale(1.1);
            transition: opacity 0.4s ease-out, visibility 0.4s ease-out, transform 0.4s ease-out;
            text-shadow: 0 0 10px var(--primary-color);
        }

        .loading-screen.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }

        .loading-animation {
            width: 100px;
            height: 100px;
            border: 4px solid var(--primary-color);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite, glowPulse 1.5s ease-in-out infinite alternate;
            margin-bottom: 20px;
            box-shadow: 0 0 20px var(--primary-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes glowPulse {
            0% { box-shadow: 0 0 15px var(--primary-color); }
            100% { box-shadow: 0 0 30px var(--primary-color), 0 0 40px rgba(0, 238, 255, 0.4); }
        }

        .loading-text {
            color: var(--primary-color);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5em;
            letter-spacing: 2px;
            opacity: 0;
            animation: textFadePulse 2s infinite alternate;
        }

        @keyframes textFadePulse {
            0% { opacity: 0.3; transform: translateY(5px); }
            50% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0.3; transform: translateY(5px); }
        }

        /* Scanline effect */
        .loading-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0px,
                transparent 1px,
                rgba(0, 238, 255, 0.05) 1px,
                rgba(0, 238, 255, 0.05) 2px
            );
            pointer-events: none;
            opacity: 0.5;
        }

        /* Header */
        .header {
            background-color: #0E0E0E;
            padding: 15px 20px;
            border-bottom: 2px solid var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 10px var(--border-glow);
            z-index: 100;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-color);
            font-size: 1.8em;
            text-shadow: 0 0 8px var(--primary-color);
            letter-spacing: 1px;
            cursor: pointer;
        }

        .nav {
            display: flex;
            gap: 20px;
        }

        .nav-item {
            background: none;
            border: none;
            color: var(--text-light);
            font-family: 'Share Tech Mono', monospace;
            font-size: 1em;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            text-decoration: none;
        }

        .nav-item:hover {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 238, 255, 0.4);
        }

        .nav-item.active {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .online-users-count {
            color: var(--primary-color);
            font-size: 0.9em;
            background-color: #002222;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid var(--secondary-color);
        }

        /* Notifications */
        .notification-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 15px;
            height: 15px;
            background-color: var(--notification-border);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--background-dark);
            font-size: 0.7em;
            font-weight: bold;
            box-shadow: 0 0 8px var(--notification-border);
            animation: pulseNotification 1.5s infinite alternate;
        }

        @keyframes pulseNotification {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 12px var(--notification-border); }
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
            position: relative;
        }

        /* Screen Sections */
        .screen {
            background-color: #0E0E0E;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            box-shadow: inset 0 0 8px var(--border-glow);
            padding: 20px;
            display: none; /* Varsayılan olarak gizli */
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: absolute; /* Stacked position for smooth transitions */
            top: 0;
            left: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease-out; /* Sayfa geçiş animasyonu */
        }

        .screen.active {
            display: flex;
            opacity: 1;
            pointer-events: all;
            position: static; /* Aktif ekranı akışa dahil et */
        }

        /* Login/Register Screen */
        #auth-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .auth-form {
            background-color: #1A1A1A;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 238, 255, 0.4);
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--primary-color);
        }

        .auth-form h2 {
            color: var(--primary-color);
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 25px;
            text-shadow: 0 0 10px var(--primary-color);
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light);
        }

        .form-group input, .form-group textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: #0A0A0A;
            color: var(--primary-color);
            font-family: 'Share Tech Mono', monospace;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-glow);
        }

        .btn {
            background-color: var(--primary-color);
            color: var(--background-dark);
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            margin-top: 10px;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .btn:hover {
            background-color: #00BBCC;
            box-shadow: 0 0 15px var(--primary-color);
        }

        .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }

        .switch-link {
            display: block;
            margin-top: 20px;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9em;
            transition: color 0.3s ease;
        }

        .switch-link:hover {
            color: #00BBCC;
            text-shadow: 0 0 8px var(--primary-color);
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(10px);
        }

        .status-message.active {
            opacity: 1;
            transform: translateY(0);
        }

        .status-message.positive {
            background-color: rgba(46, 204, 64, 0.2);
            color: var(--success-green);
            border: 1px solid var(--success-green);
            box-shadow: 0 0 8px rgba(46, 204, 64, 0.4);
        }

        .status-message.negative {
            background-color: rgba(255, 65, 54, 0.2);
            color: var(--error-red);
            border: 1px solid var(--error-red);
            box-shadow: 0 0 8px rgba(255, 65, 54, 0.4);
        }

        /* Chat Screen */
        #chat-screen {
            flex-grow: 1;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #0A0A0A;
            scroll-behavior: smooth;
            box-shadow: inset 0 0 5px rgba(0, 238, 255, 0.1);
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            line-height: 1.4;
            cursor: pointer;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        .message:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 238, 255, 0.2);
        }

        .message.sent {
            background-color: #002D3A;
            margin-left: auto;
            border-bottom-right-radius: 2px;
            border: 1px solid #005F7C;
            color: #E0E0E0;
        }

        .message.received {
            background-color: #2A0A3D;
            margin-right: auto;
            border-bottom-left-radius: 2px;
            border: 1px solid #4F007C;
            color: #E0E0E0;
        }

        .message .sender-info {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
            display: block;
            text-shadow: 0 0 5px rgba(0, 238, 255, 0.5);
        }

        .rank-display {
            font-size: 0.8em;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 5px;
            font-family: 'Orbitron', sans-serif;
            background-color: rgba(0, 77, 64, 0.5);
            border: 1px solid #00EEFF;
            color: #00EEFF;
            white-space: nowrap;
        }

        /* Rank specific colors */
        .rank-X-5 { background-color: #4D0000; border-color: #FF0000; color: #FF0000; box-shadow: 0 0 5px #FF0000; } /* Admin */
        .rank-X-4 { background-color: #4D2600; border-color: #FFA500; color: #FFA500; box-shadow: 0 0 5px #FFA500; } /* Mod */
        .rank-X-3 { background-color: #003300; border-color: #00CC00; color: #00CC00; box-shadow: 0 0 5px #00CC00; } /* VIP */
        .rank-X-2 { background-color: #00004D; border-color: #0000FF; color: #0000FF; box-shadow: 0 0 5px #0000FF; } /* Elite */
        .rank-X-1 { background-color: #330033; border-color: #FF00FF; color: #FF00FF; box-shadow: 0 0 5px #FF00FF; } /* Member */
        .rank-X-0 { background-color: #000000; border-color: #888888; color: #888888; box-shadow: 0 0 5px #888888; } /* Newbie */

        .specialty-display {
            font-size: 0.75em;
            color: #BBBBBB;
            margin-left: 5px;
            font-style: italic;
        }

        .message-text {
            color: var(--text-light);
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .timestamp {
            font-size: 0.7em;
            color: #AAAAAA;
            text-align: right;
            display: block;
            margin-top: 5px;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input-area input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: #0A0A0A;
            color: var(--primary-color);
            outline: none;
            box-shadow: inset 0 0 5px rgba(0, 238, 255, 0.1);
        }
        .chat-input-area input:focus {
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-glow);
        }

        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }

        .message-actions button {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-size: 0.7em;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .message-actions button:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 0 8px rgba(0, 238, 255, 0.4);
        }

        .reply-to-bar {
            background-color: #222;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--secondary-color);
            font-size: 0.9em;
            color: #BBBBBB;
            box-shadow: inset 0 0 5px rgba(0, 238, 255, 0.1);
        }

        .reply-to-bar span {
            flex-grow: 1;
            margin-right: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-to-bar button {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.2em;
            cursor: pointer;
        }

        /* Friends List Screen */
        #friends-list-screen {
            flex-grow: 1;
        }

        .friends-container, .requests-container, .private-rooms-container {
            background-color: #0A0A0A;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: inset 0 0 5px rgba(0, 238, 255, 0.1);
            height: calc(33.3% - 20px); /* Yüksekliği ayarla */
            overflow-y: auto;
        }

        .friends-container h3, .requests-container h3, .private-rooms-container h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 5px var(--primary-color);
        }

        .friends-list, .requests-list, .private-rooms-list {
            list-style: none;
            padding: 0;
        }

        .friend-item, .request-item, .private-room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 77, 64, 0.5);
            transition: background-color 0.2s ease;
        }

        .friend-item:last-child, .request-item:last-child, .private-room-item:last-child {
            border-bottom: none;
        }

        .friend-item:hover, .request-item:hover, .private-room-item:hover {
            background-color: rgba(0, 77, 64, 0.1);
        }

        .friend-info, .request-info, .private-room-info {
            color: var(--text-light);
            cursor: pointer;
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .friend-info .username, .request-info .username, .private-room-info .room-name {
            font-weight: bold;
            color: var(--primary-color);
            margin-right: 10px;
        }

        .friend-actions, .request-actions, .private-room-actions {
            display: flex;
            gap: 8px;
        }

        .friend-actions button, .request-actions button, .private-room-actions button {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .friend-actions button.remove-friend-btn {
            background-color: #5C0000;
            border-color: #FF0000;
            color: #FF0000;
        }

        .request-actions button.accept-btn {
            background-color: #004D00;
            border-color: #00CC00;
            color: #00CC00;
        }

        .request-actions button.reject-btn {
            background-color: #4D0000;
            border-color: #FF0000;
            color: #FF0000;
        }

        .friend-actions button:hover, .request-actions button:hover, .private-room-actions button:hover {
            background-color: #00665C;
            box-shadow: 0 0 8px var(--primary-color);
        }

        .friend-actions button.remove-friend-btn:hover {
            background-color: #6C0000;
            box-shadow: 0 0 8px #FF0000;
        }

        .request-actions button.accept-btn:hover {
            background-color: #005A00;
            box-shadow: 0 0 8px #00CC00;
        }

        .request-actions button.reject-btn:hover {
            background-color: #6D0000;
            box-shadow: 0 0 8px #FF0000;
        }

        .online-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #333;
        }

        .online-status-dot.online {
            background-color: var(--success-green);
            box-shadow: 0 0 5px var(--success-green);
        }

        .online-status-dot.offline {
            background-color: #888;
        }

        /* Settings Screen */
        #settings-screen {
            flex-grow: 1;
        }

        .profile-card {
            background-color: #0A0A0A;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--secondary-color);
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 238, 255, 0.2);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--primary-color);
            margin: 0 auto 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            font-family: 'Orbitron', sans-serif;
            color: var(--background-dark);
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color);
        }

        .profile-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            color: var(--primary-color);
            margin-bottom: 5px;
            text-shadow: 0 0 8px var(--primary-color);
        }

        .profile-rank {
            font-size: 1.1em;
            color: var(--text-light);
            margin-bottom: 5px; /* Uyarı sayısı için boşluk */
        }

        .profile-warnings-count {
            font-size: 0.9em;
            color: var(--warning-red);
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-group label {
            font-weight: bold;
            color: var(--primary-color);
        }

        .setting-group input {
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: #0A0A0A;
            color: var(--primary-color);
            outline: none;
            box-shadow: inset 0 0 5px rgba(0, 238, 255, 0.1);
        }
        .setting-group input:focus {
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-glow);
        }

        .update-btn {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .update-btn:hover {
            background-color: #00665C;
            box-shadow: 0 0 10px var(--primary-color);
        }

        /* Admin Panel Screen */
        #admin-panel-screen {
            flex-grow: 1;
        }

        .admin-section {
            background-color: #0A0A0A;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--secondary-color);
            margin-bottom: 20px;
            box-shadow: inset 0 0 5px rgba(0, 238, 255, 0.1);
        }

        .admin-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 5px var(--primary-color);
        }

        .user-list {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 77, 64, 0.5);
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-info {
            color: var(--text-light);
            flex-grow: 1;
        }

        .user-info .username {
            font-weight: bold;
            color: var(--primary-color);
        }

        .user-actions button {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 8px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .user-actions button:hover {
            background-color: #00665C;
            box-shadow: 0 0 8px var(--primary-color);
        }

        .user-actions select {
            background-color: #0A0A0A;
            color: var(--primary-color);
            border: 1px solid var(--secondary-color);
            border-radius: 5px;
            padding: 5px;
            margin-left: 8px;
            outline: none;
        }
        .user-actions select option {
            background-color: #0A0A0A;
            color: var(--primary-color);
        }

        /* Announcement Section */
        .announcement-input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .announcement-input-area textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* --- Modals (Pop-ups) --- */
        .modal {
            display: flex;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #1A1A1A;
            border: 1px solid var(--secondary-color);
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 25px var(--border-glow);
            position: relative;
            transform: translateY(-20px) scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .modal.active .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color);
        }

        .profile-modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--primary-color);
            object-fit: cover;
            margin-bottom: 10px;
            box-shadow: 0 0 15px var(--border-glow);
        }

        .modal-profile-username {
            color: var(--primary-color);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            margin: 5px 0;
            text-shadow: 0 0 8px var(--border-glow);
        }

        .modal-profile-detail {
            color: #bbb;
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        .profile-modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        /* Private Chat Modal */
        .private-chat-content {
            max-width: 600px;
            height: 80%;
            display: flex;
            flex-direction: column;
        }

        .private-chat-header {
            color: var(--primary-color);
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            font-size: 1.6em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--secondary-color);
            text-shadow: 0 0 8px var(--primary-color);
        }

        .private-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #0E0E0E;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: inset 0 0 5px rgba(0, 238, 255, 0.1);
        }

        .private-chat-input-area {
            display: flex;
            gap: 10px;
        }

        .private-chat-input-area input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: #0A0A0A;
            color: var(--primary-color);
            outline: none;
            box-shadow: inset 0 0 5px rgba(0, 238, 255, 0.1);
        }
        .private-chat-input-area input:focus {
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-glow);
        }

        /* Announcement Modal */
        #announcement-modal .modal-content {
            max-width: 500px;
        }

        #announcement-modal h3 {
            color: var(--primary-color);
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--primary-color);
        }

        #announcement-modal p {
            font-size: 1.1em;
            line-height: 1.6;
            color: var(--text-light);
            margin-bottom: 25px;
            white-space: pre-wrap; /* Boşlukları ve satır sonlarını koru */
            word-wrap: break-word;
        }

        #announcement-modal .btn-read {
            display: block;
            width: fit-content;
            margin: 0 auto;
        }

        /* Warning Overlay */
        .warning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .warning-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .warning-box {
            background-color: #1A1A1A;
            border: 3px solid var(--warning-red);
            border-radius: 15px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 30px var(--warning-glow);
            animation: pulseWarning 1s infinite alternate;
            position: relative;
        }

        @keyframes pulseWarning {
            0% { box-shadow: 0 0 20px var(--warning-glow), inset 0 0 10px var(--warning-glow); }
            100% { box-shadow: 0 0 40px var(--warning-glow), inset 0 0 20px var(--warning-glow); }
        }

        .warning-box h3 {
            color: var(--warning-red);
            font-family: 'Orbitron', sans-serif;
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 0 0 15px var(--warning-red);
        }

        .warning-box p {
            color: var(--text-light);
            font-size: 1.2em;
            line-height: 1.5;
            margin-bottom: 30px;
        }

        .warning-close-btn {
            background-color: var(--warning-red);
            color: var(--background-dark);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1em;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 0 10px var(--warning-red);
        }

        .warning-close-btn:hover {
            background-color: #CC0000;
            box-shadow: 0 0 20px var(--warning-red);
        }
    </style>
</head>
<body>
    <div id="particles-js"></div> <div class="loading-screen" id="loading-screen">
        <div class="loading-animation"></div>
        <div class="loading-text" id="loading-text">Veri Akışı Sağlanıyor...</div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo" id="logo">QUANTUM NEXUS</div>
            <nav class="nav">
                <button class="nav-item" data-screen="chat-screen" id="chat-nav-item">Sohbet</button>
                <button class="nav-item" data-screen="friends-list-screen" id="friends-nav-item">
                    Arkadaşlar
                    <span class="notification-indicator" id="friend-request-notification" style="display:none;"></span>
                </button>
                <button class="nav-item" data-screen="settings-screen" id="settings-nav-item">Ayarlar</button>
                <button class="nav-item" data-screen="admin-panel-screen" id="admin-panel-nav-item" style="display:none;">Yönetim Paneli</button>
                <span class="online-users-count" id="online-users-count">Çevrimiçi: 0</span>
                
<button class="nav-item" data-screen="encryption-screen" id="encryption-nav-item">Şifreleme</button>
<button class="nav-item" id="logout-btn">Çıkış Yap</button>
            </nav>
        </div>

        <div class="main-content">
            <section id="auth-screen" class="screen active">
                <div class="auth-form">
                    <h2 id="auth-header">Giriş Yap</h2>
                    <div class="form-group">
                        <label for="email-input">E-posta Adresi:</label>
                        <input type="email" id="email-input" placeholder="kullanici@nexus.com" required>
                    </div>
                    <div class="form-group">
                        <label for="password-input">Şifre:</label>
                        <input type="password" id="password-input" placeholder="Şifreniz" required>
                    </div>
                    <button class="btn" id="auth-btn">Giriş Yap</button>
                    <div class="status-message" id="auth-status-message"></div>
                    <a href="#" class="switch-link" id="switch-auth-link">Yeni Erişim Oluştur</a>
                </div>
            </section>

            <section id="chat-screen" class="screen">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        </div>
                    <div class="reply-to-bar" id="reply-to-bar" style="display: none;">
                        <span>Yanıtlanıyor: <strong id="reply-to-text"></strong></span>
                        <button id="cancel-reply-btn">&times;</button>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-message-input" placeholder="Mesajınızı girin..." required>
                        <button class="btn" id="send-message-btn">Gönder</button>
                    </div>
                </div>
            </section>

            <section id="friends-list-screen" class="screen">
                <div class="friends-container">
                    <h3>Bağlantılar (Arkadaşlar)</h3>
                    <ul class="friends-list" id="friends-list">
                        </ul>
                </div>

                <div class="requests-container">
                    <h3>Bekleyen Erişim İstekleri</h3>
                    <ul class="requests-list" id="friend-requests-list">
                        </ul>
                </div>

                <div class="private-rooms-container">
                    <h3>Özel Sohbet Tünelleri</h3>
                    <ul class="private-rooms-list" id="private-rooms-list">
                        </ul>
                </div>
            </section>

            <section id="settings-screen" class="screen">
                <div class="profile-card">
                    <div class="profile-avatar" id="profile-avatar">U</div>
                    <h2 class="profile-name" id="profile-name">Kullanıcı Adı</h2>
                    <p class="profile-rank" id="profile-rank">Rütbe: X-0</p>
                    <p class="profile-warnings-count" id="profile-warnings-count">Uyarı Sayısı: 0</p>
                    <p class="profile-uid">UID: <span id="profile-uid"></span></p>
                </div>

                <div class="settings-form">
                    <div class="setting-group">
                        <label for="current-email-input">E-posta Adresi:</label>
                        <input type="email" id="current-email-input" disabled>
                    </div>
                    <div class="setting-group">
                        <label for="username-input">Kullanıcı Adı:</label>
                        <input type="text" id="username-input" placeholder="MatrixGezgini" maxlength="20">
                        <button class="btn update-btn" id="update-username-btn">Kullanıcı Adını Güncelle</button>
                    </div>
                    <div class="setting-group">
                        <label for="specialty-input">Branş:</label>
                        <input type="text" id="specialty-input" placeholder="Yazılım Geliştirici / Ağ Analisti" maxlength="30">
                        <button class="btn update-btn" id="update-specialty-btn">Branşı Güncelle</button>
                    </div>
                    <div class="setting-group">
                        <label for="new-password-input">Yeni Şifre:</label>
                        <input type="password" id="new-password-input" placeholder="Yeni şifrenizi girin">
                        <label for="confirm-password-input">Şifre Tekrar:</label>
                        <input type="password" id="confirm-password-input" placeholder="Yeni şifrenizi tekrar girin">
                        <button class="btn update-btn" id="update-password-btn">Şifreyi Güncelle</button>
                    </div>
                    <div class="status-message" id="settings-status-message"></div>
                </div>
            </section>

            <section id="admin-panel-screen" class="screen">
                <div class="admin-section">
                    <h3>Kullanıcı Yönetimi</h3>
                    <ul class="user-list" id="user-management-list">
                        </ul>
                </div>
                <div class="admin-section">
                    <h3>Duyuru Yönetimi</h3>
                    <div class="announcement-input-area">
                        <label for="announcement-text-area">Yeni Duyuru:</label>
                        <textarea id="announcement-text-area" placeholder="En son güncel duyurunuzu buraya girin..."></textarea>
                        <button class="btn" id="publish-announcement-btn">Duyuruyu Yayınla</button>
                    </div>
                    <div class="status-message" id="announcement-status-message"></div>
                </div>
                <div class="admin-section">
                    <h3>Genel Ayarlar</h3>
                    <p>Buraya genel sistem ayarları veya daha fazla yönetim aracı eklenebilir.</p>
                </div>
            </section>

<section id="encryption-screen" class="screen">
    <div class="chat-container">
        <h2 style="color: var(--primary-color); text-align:center;">Şifreleme & Çözme Aracı</h2>
        <div class="form-group">
            <label for="plain-text">Şifrelenecek Metin:</label>
            <textarea id="plain-text" rows="4" placeholder="Metni buraya yaz..." style="width: 100%;"></textarea>
            <button class="btn" onclick="encryptText()">Şifrele</button>
        </div>
        <div class="form-group">
            <label for="encrypted-text">Şifreli Metin:</label>
            <textarea id="encrypted-text" rows="4" placeholder="Şifreli metin burada görünecek..." style="width: 100%;"></textarea>
            <button class="btn" onclick="decryptText()">Çözümle</button>
        </div>
    </div>
</section>
</section>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="profile-modal-close">&times;</span>
            <div class="profile-modal-header">
                <img src="https://via.placeholder.com/80/004D40/00EEFF?text=USER" alt="Profil Resmi" class="modal-profile-pic">
                <h3 id="modal-profile-username"></h3>
                <p id="modal-profile-specialty" class="modal-profile-detail"></p>
                <p id="modal-profile-rank" class="modal-profile-detail"></p>
                <p id="modal-profile-warnings-count" class="profile-warnings-count"></p>
            </div>
            <div class="profile-modal-actions">
                <button class="btn" id="add-friend-btn">Arkadaş Ekle</button>
                <button class="btn" id="send-private-message-btn">Özel Mesaj Gönder</button>
            </div>
        </div>
    </div>

    <div id="private-chat-modal" class="modal">
        <div class="modal-content private-chat-content">
            <span class="close-button" id="private-chat-close">&times;</span>
            <h3 id="private-chat-header"></h3>
            <div class="private-chat-messages" id="private-chat-messages">
                </div>
            <div class="private-chat-input-area">
                <input type="text" id="private-message-input" placeholder="Özel komutunuzu girin..." required>
                <button id="send-private-message-btn-modal" class="btn">Gönder</button>
            </div>
        </div>
    </div>

    <div id="announcement-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="announcement-modal-close">&times;</span>
            <h3>En Son Duyuru</h3>
            <p id="announcement-text"></p>
            <button class="btn btn-read" id="mark-announcement-read-btn">Okundu Olarak İşaretle</button>
        </div>
    </div>

    <div id="warning-overlay" class="warning-overlay">
        <div class="warning-box">
            <h3>SİSTEM UYARISI!</h3>
            <p id="warning-message-text"></p>
            <button class="warning-close-btn" id="warning-close-btn">Anlaşıldı</button>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js">
function showToastMessage() {
    const toast = document.getElementById("message-toast");
    toast.style.display = "block";
    document.getElementById("notification-sound").play();
    toast.onclick = () => {
        showScreen("chat-screen");
        toast.style.display = "none";
    };
    setTimeout(() => {
        toast.style.display = "none";
    }, 5000);
}

// Chat'e gelen mesajlarda tetiklenmeli
// displayMessage gibi fonksiyon içine: showToastMessage();

function encryptText() {
    const plainText = document.getElementById("plain-text").value;
    const encoded = btoa(plainText);
    document.getElementById("encrypted-text").value = encoded;
}
function decryptText() {
    const encryptedText = document.getElementById("encrypted-text").value;
    try {
        const decoded = atob(encryptedText);
        document.getElementById("plain-text").value = decoded;
    } catch (e) {
        alert("Geçersiz şifreli metin!");
    }
}

</script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js">
function showToastMessage() {
    const toast = document.getElementById("message-toast");
    toast.style.display = "block";
    document.getElementById("notification-sound").play();
    toast.onclick = () => {
        showScreen("chat-screen");
        toast.style.display = "none";
    };
    setTimeout(() => {
        toast.style.display = "none";
    }, 5000);
}

// Chat'e gelen mesajlarda tetiklenmeli
// displayMessage gibi fonksiyon içine: showToastMessage();

function encryptText() {
    const plainText = document.getElementById("plain-text").value;
    const encoded = btoa(plainText);
    document.getElementById("encrypted-text").value = encoded;
}
function decryptText() {
    const encryptedText = document.getElementById("encrypted-text").value;
    try {
        const decoded = atob(encryptedText);
        document.getElementById("plain-text").value = decoded;
    } catch (e) {
        alert("Geçersiz şifreli metin!");
    }
}

</script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js">
function showToastMessage() {
    const toast = document.getElementById("message-toast");
    toast.style.display = "block";
    document.getElementById("notification-sound").play();
    toast.onclick = () => {
        showScreen("chat-screen");
        toast.style.display = "none";
    };
    setTimeout(() => {
        toast.style.display = "none";
    }, 5000);
}

// Chat'e gelen mesajlarda tetiklenmeli
// displayMessage gibi fonksiyon içine: showToastMessage();

function encryptText() {
    const plainText = document.getElementById("plain-text").value;
    const encoded = btoa(plainText);
    document.getElementById("encrypted-text").value = encoded;
}
function decryptText() {
    const encryptedText = document.getElementById("encrypted-text").value;
    try {
        const decoded = atob(encryptedText);
        document.getElementById("plain-text").value = decoded;
    } catch (e) {
        alert("Geçersiz şifreli metin!");
    }
}

</script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js">
function showToastMessage() {
    const toast = document.getElementById("message-toast");
    toast.style.display = "block";
    document.getElementById("notification-sound").play();
    toast.onclick = () => {
        showScreen("chat-screen");
        toast.style.display = "none";
    };
    setTimeout(() => {
        toast.style.display = "none";
    }, 5000);
}

// Chat'e gelen mesajlarda tetiklenmeli
// displayMessage gibi fonksiyon içine: showToastMessage();

function encryptText() {
    const plainText = document.getElementById("plain-text").value;
    const encoded = btoa(plainText);
    document.getElementById("encrypted-text").value = encoded;
}
function decryptText() {
    const encryptedText = document.getElementById("encrypted-text").value;
    try {
        const decoded = atob(encryptedText);
        document.getElementById("plain-text").value = decoded;
    } catch (e) {
        alert("Geçersiz şifreli metin!");
    }
}

</script>
    <script>
        // Your Firebase configuration
       const firebaseConfig = {
  apiKey: "AIzaSyDfOV4i2BNdBw-JaTdyVTMYGVlJbn4wokI",
  authDomain: "xprotokol-1c921.firebaseapp.com",
  projectId: "xprotokol-1c921",
  storageBucket: "xprotokol-1c921.firebasestorage.app",
  messagingSenderId: "807546069984",
  appId: "1:807546069984:web:2be71812e56c331af34185",
  measurementId: "G-NC4696P1V5"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const loadingText = document.getElementById('loading-text');
        const header = document.querySelector('.header');
        const navItems = document.querySelectorAll('.nav-item');
        const screens = document.querySelectorAll('.screen');
        const authScreen = document.getElementById('auth-screen');
        const chatScreen = document.getElementById('chat-screen');
        const friendsListScreen = document.getElementById('friends-list-screen'); // Yeni
        const settingsScreen = document.getElementById('settings-screen');
        const adminPanelScreen = document.getElementById('admin-panel-screen');

        // Auth elements
        const authHeader = document.getElementById('auth-header');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const authBtn = document.getElementById('auth-btn');
        const authStatusMessage = document.getElementById('auth-status-message');
        const switchAuthLink = document.getElementById('switch-auth-link');
        let isLoginMode = true;

        // Chat elements
        const chatMessages = document.getElementById('chat-messages');
        const chatMessageInput = document.getElementById('chat-message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const replyToBar = document.getElementById('reply-to-bar');
        const replyToText = document.getElementById('reply-to-text');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        let repliedMessageId = null;
        let repliedMessageText = null;

        // Friends List elements
        const friendsList = document.getElementById('friends-list');
        const friendRequestsList = document.getElementById('friend-requests-list');
        const privateRoomsList = document.getElementById('private-rooms-list');
        const friendsNavItem = document.getElementById('friends-nav-item');
        const friendRequestNotification = document.getElementById('friend-request-notification');

        // Settings elements
        const profileAvatar = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const profileRank = document.getElementById('profile-rank');
        const profileWarningsCount = document.getElementById('profile-warnings-count'); // Yeni
        const profileUID = document.getElementById('profile-uid');
        const currentEmailInput = document.getElementById('current-email-input');
        const usernameInput = document.getElementById('username-input');
        const updateUsernameBtn = document.getElementById('update-username-btn');
        const specialtyInput = document.getElementById('specialty-input');
        const updateSpecialtyBtn = document.getElementById('update-specialty-btn');
        const newPasswordInput = document.getElementById('new-password-input');
        const confirmPasswordInput = document.getElementById('confirm-password-input');
        const updatePasswordBtn = document.getElementById('update-password-btn');
        const settingsStatusMessage = document.getElementById('settings-status-message');

        // Admin panel elements
        const userManagementList = document.getElementById('user-management-list');
        const adminPanelNavItem = document.getElementById('admin-panel-nav-item');
        const announcementTextArea = document.getElementById('announcement-text-area'); // Yeni
        const publishAnnouncementBtn = document.getElementById('publish-announcement-btn'); // Yeni
        const announcementStatusMessage = document.getElementById('announcement-status-message'); // Yeni

        // Header elements
        const logoutBtn = document.getElementById('logout-btn');
        const onlineUsersCount = document.getElementById('online-users-count');
        const logo = document.getElementById('logo');

        // Profile Modal elements
        const profileModal = document.getElementById('profile-modal');
        const profileModalCloseBtn = document.getElementById('profile-modal-close');
        const modalProfileUsername = document.getElementById('modal-profile-username');
        const modalProfileSpecialty = document.getElementById('modal-profile-specialty');
        const modalProfileRank = document.getElementById('modal-profile-rank');
        const modalProfileWarningsCount = document.getElementById('modal-profile-warnings-count'); // Yeni
        const addFriendBtn = document.getElementById('add-friend-btn');
        const sendPrivateMessageBtn = document.getElementById('send-private-message-btn');
        let targetUserUid = null; // Profilini görüntülediğimiz kullanıcının UID'si

        // Private Chat Modal elements
        const privateChatModal = document.getElementById('private-chat-modal');
        const privateChatCloseBtn = document.getElementById('private-chat-close');
        const privateChatHeader = document.getElementById('private-chat-header');
        const privateChatMessages = document.getElementById('private-chat-messages');
        const privateMessageInput = document.getElementById('private-message-input');
        const sendPrivateMessageBtnModal = document.getElementById('send-private-message-btn-modal');

        let currentPrivateChatId = null; // Aktif özel sohbet ID'si
        let currentPrivateChatListener = null; // Özel sohbet dinleyicisini kaldırmak için
        let currentPrivateChatTargetUsername = null; // Özel mesaj gönderilen kişinin adı

        // Announcement Modal elements
        const announcementModal = document.getElementById('announcement-modal');
        const announcementModalCloseBtn = document.getElementById('announcement-modal-close');
        const announcementText = document.getElementById('announcement-text');
        const markAnnouncementReadBtn = document.getElementById('mark-announcement-read-btn');
        let currentAnnouncementId = null; // Gösterilen duyurunun ID'si

        // Warning Overlay elements
        const warningOverlay = document.getElementById('warning-overlay');
        const warningMessageText = document.getElementById('warning-message-text');
        const warningCloseBtn = document.getElementById('warning-close-btn');

        // --- Global Variables ---
        let currentUserRank = "X-0"; // Varsayılan rütbe
        let currentUserName = "Misafir"; // Varsayılan isim
        let currentUserWarnings = 0; // Kullanıcının uyarı sayısı
        const availableRanks = ["X-0", "X-1", "X-2", "X-3", "X-4", "X-5"]; // Olası rütbeler
        let hasNewFriendRequests = false;
        let hasNewPrivateMessages = false;


        // Aktif dinleyicileri takip etmek için obje
        const activeListeners = {
            chatMessages: null,
            onlinePresence: null,
            onlineUsersCount: null,
            userManagement: null,
            friendRequests: null,
            friendsList: null,
            privateRoomsList: null,
            announcement: null, // Yeni
            warnings: null // Yeni
        };

        // --- Utility Functions ---
        function showAlert(type, message, element = authStatusMessage) {
            element.textContent = message;
            element.className = `status-message active ${type}`; // Sınıfları sıfırla ve yenilerini ekle
            setTimeout(() => {
                element.classList.remove('active');
            }, 3000);
        }

        // --- Loading Screen Functions ---
        function showLoadingScreen(text = "Veri Akışı Sağlanıyor...") {
            loadingText.textContent = text;
            loadingScreen.classList.add('active');
            // Header ve main-content'i gizle, loading ekranının tam görünmesini sağla
            header.style.display = 'none';
            document.querySelector('.main-content').style.display = 'none';
        }

        function hideLoadingScreen() {
            loadingScreen.classList.remove('active');
            // Header ve main-content'i tekrar göster
            header.style.display = 'flex';
            document.querySelector('.main-content').style.display = 'flex';
        }

        // --- Screen Management ---
        function showScreen(screenId) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.screen === screenId) {
                    item.classList.add('active');
                }
            });

            // Tüm dinleyicileri temizle
            Object.keys(activeListeners).forEach(key => {
                const listener = activeListeners[key];
                if (listener && listener.callback) { // Firebase on() listener'ı
                    if (key.includes('privateChat')) {
                        // Özel sohbet dinleyicileri özel olarak yönetildiği için burada kapatmıyoruz
                    } else if (key === 'friendRequests' || key === 'friendsList' || key === 'privateRoomsList' || key === 'announcement' || key === 'warnings') {
                        // Bu özel dinleyiciler kendi fonksiyonları içinde yönetilmeli
                    } else {
                        // Diğer genel dinleyicileri kapat
                        database.ref(listener.refPath).off(listener.eventType, listener.callback);
                    }
                } else if (listener && listener.unsubscribe && typeof listener.unsubscribe === 'function') { // Snapshot listener'ı
                    listener.unsubscribe();
                }
                activeListeners[key] = null;
            });

            // Ekran özel dinleyicilerini başlat
            if (screenId === 'chat-screen') {
                loadChatMessages();
            } else if (screenId === 'admin-panel-screen') {
                if (currentUserRank === "X-5") {
                    loadUserManagement();
                    loadLatestAnnouncementForAdmin(); // Admin panel duyuru alanını güncelle
                } else {
                    showAlert('negative', 'Yönetim paneline erişim yetkiniz yok.', settingsStatusMessage);
                    showScreen('chat-screen'); // Yetkisizse, kullanıcının o anki geçerli ekranına geri yönlendir
                }
            } else if (screenId === 'friends-list-screen') {
                loadFriendsAndRequests();
            } else if (screenId === 'settings-screen') {
                // Ayarlar ekranında uyarı sayısını da güncelle
                updateUserProfileDisplay(auth.currentUser.uid);
            }


            // Bildirimleri temizle (sadece arkadaşlar ve özel mesajlar için)
            updateFriendRequestNotification();
        }

        // --- Authentication ---
        authBtn.addEventListener('click', async () => {
            showLoadingScreen(isLoginMode ? "Kimlik Doğrulanıyor..." : "Yeni Erişim Oluşturuluyor...");
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                showAlert('negative', 'E-posta ve şifre gereklidir.', authStatusMessage);
                hideLoadingScreen();
                return;
            }

            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                    showAlert('positive', 'Bağlantı Kuruldu!');
                } else {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    const defaultRank = "X-0";
                    await database.ref('users/' + user.uid).set({
                        email: user.email,
                        username: user.email.split('@')[0], // Varsayılan kullanıcı adı
                        specialty: "Yeni Bağlantı", // Varsayılan branş
                        rank: defaultRank,
                        warnings: 0, // Yeni: Varsayılan uyarı sayısı
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                    showAlert('positive', 'Yeni Erişim Oluşturuldu! Bağlanıyor...');
                    console.log('Yeni kullanıcı oluşturuldu:', user.email);
                }
            } catch (error) {
                let errorMessage = 'Bir hata oluştu.';
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = 'Geçersiz e-posta adresi.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Hesabınız devre dışı bırakıldı.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'Bu e-posta ile kayıtlı kullanıcı bulunamadı.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Yanlış şifre.';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'Bu e-posta zaten kullanımda.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Şifre en az 6 karakter olmalıdır.';
                        break;
                    default:
                        errorMessage = error.message;
                }
                showAlert('negative', errorMessage, authStatusMessage);
            } finally {
                hideLoadingScreen();
            }
        });

        switchAuthLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            authHeader.textContent = isLoginMode ? 'Giriş Yap' : 'Yeni Erişim Oluştur';
            authBtn.textContent = isLoginMode ? 'Giriş Yap' : 'Hesap Oluştur';
            switchAuthLink.textContent = isLoginMode ? 'Yeni Erişim Oluştur' : 'Zaten hesabınız var mı? Giriş Yap';
            authStatusMessage.classList.remove('active'); // Hata mesajını gizle
        });

        logoutBtn.addEventListener('click', async () => {
            showLoadingScreen("Bağlantı Kesiliyor...");
            try {
                await auth.signOut();
                // AuthStateChanged listener'ı zaten auth-screen'i gösterecektir.
                showAlert('positive', 'Başarıyla çıkış yapıldı.', authStatusMessage);
            } catch (error) {
                showAlert('negative', 'Çıkış yapılırken hata oluştu: ' + error.message, authStatusMessage);
            } finally {
                hideLoadingScreen();
            }
        });

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in.
                header.style.display = 'flex';
                document.querySelector('.main-content').style.display = 'flex';
                authScreen.classList.remove('active'); // Auth ekranını gizle
                showScreen('chat-screen'); // Giriş yapınca doğrudan sohbet ekranına yönlendir
                await updateUserProfile(user); // Kullanıcı profil bilgilerini yükle/güncelle
                setupNotifications(user.uid); // Bildirim dinleyicilerini kur
                checkAndDisplayAnnouncement(user.uid); // Duyuru kontrolü
                listenForWarnings(user.uid); // Uyarıları dinle
                hideLoadingScreen();
            } else {
                // User is signed out.
                header.style.display = 'none'; // Başlığı gizle
                document.querySelector('.main-content').style.display = 'none'; // Ana içeriği gizle
                authScreen.classList.add('active'); // Auth ekranını göster
                hideLoadingScreen(); // Yükleme ekranını gizle (eğer açıksa)
                // Çıkış yapıldığında tüm dinleyicileri kaldır
                Object.keys(activeListeners).forEach(key => {
                    const listener = activeListeners[key];
                    if (listener && typeof listener.off === 'function') {
                        database.ref(listener.refPath).off(listener.eventType, listener.callback);
                    } else if (listener && listener.unsubscribe && typeof listener.unsubscribe === 'function') {
                        listener.unsubscribe();
                    }
                    activeListeners[key] = null;
                });
                // Bildirimleri sıfırla
                hasNewFriendRequests = false;
                hasNewPrivateMessages = false;
                updateFriendRequestNotification();
            }
        });

        // --- User Profile Management ---
        async function updateUserProfile(user) {
            const userRef = database.ref('users/' + user.uid);
            const snapshot = await userRef.once('value');
            let userData = snapshot.val();

            if (!userData) {
                // Kullanıcının veritabanında kaydı yoksa varsayılan bilgilerle oluştur
                const defaultRank = "X-0";
                userData = {
                    email: user.email,
                    username: user.email.split('@')[0], // Varsayılan kullanıcı adı
                    specialty: "Yeni Bağlantı", // Varsayılan branş
                    rank: defaultRank,
                    warnings: 0, // Yeni: Varsayılan uyarı sayısı
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                };
                await userRef.set(userData);
            }

            // Profil kartını güncelle
            profileName.textContent = userData.username || user.email.split('@')[0]; // Kullanıcı adı varsa onu göster
            profileRank.textContent = `Rütbe: ${userData.rank}`;
            profileWarningsCount.textContent = `Uyarı Sayısı: ${userData.warnings || 0}`; // Uyarı sayısı
            // Mevcut rütbe sınıflarını kaldır, yeni rütbe sınıfını ekle
            profileRank.classList.remove(...availableRanks.map(r => `rank-${r.replace('-', '')}`));
            profileRank.classList.add(`rank-${userData.rank.replace('-', '')}`);
            profileUID.textContent = user.uid.substring(0, 8) + '...';
            profileAvatar.textContent = (userData.username ? userData.username.charAt(0) : user.email.charAt(0)).toUpperCase();


            // Global değişkenleri güncelle
            currentUserRank = userData.rank;
            currentUserName = userData.username || user.email.split('@')[0]; // Mesajlarda kullanılacak ad
            currentUserWarnings = userData.warnings || 0;

            // Admin yetkisi kontrolü
            if (currentUserRank === "X-5") {
                adminPanelNavItem.style.display = 'block';
            } else {
                adminPanelNavItem.style.display = 'none';
            }

            // Ayarlar sayfasını güncelle
            currentEmailInput.value = user.email;
            usernameInput.value = userData.username || '';
            specialtyInput.value = userData.specialty || '';

            // Kullanıcının online durumunu takip et
            const presenceRef = database.ref('.info/connected');
            const userOnlineRef = database.ref('onlineUsers/' + user.uid);

            // Önceki dinleyicileri kaldır (bellek sızıntısını önlemek için)
            if (activeListeners.onlinePresence) {
                presenceRef.off('value', activeListeners.onlinePresence);
            }
            if (activeListeners.userOnlineRef) { // Daha önce tanımladıysak temizle
                activeListeners.userOnlineRef.onDisconnect().cancel();
            }

            activeListeners.onlinePresence = presenceRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    activeListeners.userOnlineRef = userOnlineRef; // onDisconnect() referansını sakla
                    userOnlineRef.onDisconnect().remove(); // Bağlantı kesildiğinde onlineUsers'tan kaldır
                    userOnlineRef.set({
                        email: user.email,
                        username: currentUserName,
                        rank: currentUserRank,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });

            const onlineUsersRef = database.ref('onlineUsers');
            if (activeListeners.onlineUsersCount) {
                onlineUsersRef.off('value', activeListeners.onlineUsersCount);
            }
            activeListeners.onlineUsersCount = onlineUsersRef.on('value', (snapshot) => {
                onlineUsersCount.textContent = `Çevrimiçi: ${snapshot.numChildren()}`;
            });
        }

        // Bu fonksiyonu diğer yerlerde de kullanabilmek için ayırdık
        async function updateUserProfileDisplay(uid) {
            const userRef = database.ref('users/' + uid);
            const snapshot = await userRef.once('value');
            const userData = snapshot.val();
            if (userData) {
                profileName.textContent = userData.username || userData.email.split('@')[0];
                profileRank.textContent = `Rütbe: ${userData.rank}`;
                profileWarningsCount.textContent = `Uyarı Sayısı: ${userData.warnings || 0}`;
                profileRank.classList.remove(...availableRanks.map(r => `rank-${r.replace('-', '')}`));
                profileRank.classList.add(`rank-${userData.rank.replace('-', '')}`);
                profileUID.textContent = uid.substring(0, 8) + '...';
                profileAvatar.textContent = (userData.username ? userData.username.charAt(0) : userData.email.charAt(0)).toUpperCase();
                currentUserRank = userData.rank;
                currentUserName = userData.username || userData.email.split('@')[0];
                currentUserWarnings = userData.warnings || 0;
            }
        }


        updateUsernameBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                showAlert('negative', 'Lütfen giriş yapın.', settingsStatusMessage);
                return;
            }
            const newUsername = usernameInput.value.trim();
            if (newUsername.length < 3 || newUsername.length > 20) {
                showAlert('negative', 'Kullanıcı adı 3 ile 20 karakter arasında olmalıdır.', settingsStatusMessage);
                return;
            }

            showLoadingScreen("Kullanıcı Adı Güncelleniyor...");
            try {
                const usernameSnapshot = await database.ref('users').orderByChild('username').equalTo(newUsername).once('value');
                if (usernameSnapshot.exists()) {
                    let isDuplicate = false;
                    usernameSnapshot.forEach(child => {
                        if (child.key !== user.uid) { // Kendi kullanıcı adımızı saymıyoruz
                            isDuplicate = true;
                        }
                    });
                    if (isDuplicate) {
                        showAlert('negative', 'Bu kullanıcı adı zaten kullanılıyor.', settingsStatusMessage);
                        hideLoadingScreen();
                        return;
                    }
                }

                await database.ref('users/' + user.uid).update({ username: newUsername });
                await updateUserProfile(user); // Güncel profil verilerini yeniden yükle
                showAlert('positive', 'Kullanıcı adınız başarıyla güncellendi!', settingsStatusMessage);
            } catch (error) {
                showAlert('negative', 'Kullanıcı adı güncellenirken hata oluştu: ' + error.message, settingsStatusMessage);
                console.error('Kullanıcı adı güncelleme hatası:', error);
            } finally {
                hideLoadingScreen();
            }
        });

        updateSpecialtyBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                showAlert('negative', 'Lütfen giriş yapın.', settingsStatusMessage);
                return;
            }
            const newSpecialty = specialtyInput.value.trim();
            if (newSpecialty.length > 30) {
                showAlert('negative', 'Branş 30 karakterden uzun olamaz.', settingsStatusMessage);
                return;
            }

            showLoadingScreen("Branş Güncelleniyor...");
            try {
                await database.ref('users/' + user.uid).update({ specialty: newSpecialty });
                await updateUserProfile(user); // Güncel profil verilerini yeniden yükle
                showAlert('positive', 'Branşınız başarıyla güncellendi!', settingsStatusMessage);
            } catch (error) {
                showAlert('negative', 'Branş güncellenirken hata oluştu: ' + error.message, settingsStatusMessage);
                console.error('Branş güncelleme hatası:', error);
            } finally {
                hideLoadingScreen();
            }
        });

        updatePasswordBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                showAlert('negative', 'Lütfen giriş yapın.', settingsStatusMessage);
                return;
            }

            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (newPassword !== confirmPassword) {
                showAlert('negative', 'Şifreler uyuşmuyor.', settingsStatusMessage);
                return;
            }
            if (newPassword.length < 6) {
                showAlert('negative', 'Yeni şifre en az 6 karakter olmalıdır.', settingsStatusMessage);
                return;
            }

            showLoadingScreen("Şifre Güncelleniyor...");
            try {
                await user.updatePassword(newPassword);
                showAlert('positive', 'Şifreniz başarıyla güncellendi!', settingsStatusMessage);
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
            } catch (error) {
                let errorMessage = 'Şifre güncellenirken hata oluştu.';
                if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Güvenlik nedeniyle, şifrenizi değiştirmek için yakın zamanda giriş yapmış olmanız gerekmektedir. Lütfen çıkış yapıp tekrar giriş yapın.';
                } else {
                    errorMessage = error.message;
                }
                showAlert('negative', errorMessage, settingsStatusMessage);
                console.error('Şifre güncelleme hatası:', error);
            } finally {
                hideLoadingScreen();
            }
        });

        // --- Chat Functions ---
        function loadChatMessages() {
            if (activeListeners.chatMessages) {
                database.ref('messages').off('child_added', activeListeners.chatMessages.callback);
            }

            const chatCallback = (snapshot) => {
                const message = snapshot.val();
                const messageId = snapshot.key;
                displayMessage(message, messageId);
            };

            // `on` kullanarak yeni mesajları gerçek zamanlı dinle
            database.ref('messages').limitToLast(100).on('child_added', chatCallback);
            activeListeners.chatMessages = {
                refPath: 'messages',
                eventType: 'child_added',
                callback: chatCallback
            };
        }

        function displayMessage(message, messageId) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.dataset.messageId = messageId; // Mesaj ID'sini ekle
            messageElement.dataset.senderUid = message.uid; // Gönderenin UID'sini ekle

            const currentUser = auth.currentUser;
            if (currentUser && message.uid === currentUser.uid) {
                messageElement.classList.add('sent');
            } else {
                messageElement.classList.add('received');
            }

            const senderInfo = document.createElement('span');
            senderInfo.classList.add('sender-info');
            // Mesajda kullanıcının adını ve branşını göster (varsa)
            senderInfo.innerHTML = `${message.name || message.email.split('@')[0]} <span class="rank-display rank-${message.rank.replace('-', '')}">[${message.rank}]</span> ${message.specialty ? `<span class="specialty-display">(${message.specialty})</span>` : ''}:`;

            if (message.replyTo && message.replyToText) {
                const replyToDiv = document.createElement('div');
                replyToDiv.classList.add('reply-indicator');
                replyToDiv.innerHTML = `&gt; ${message.replyToText}`;
                messageElement.appendChild(replyToDiv);
            }

            const messageText = document.createElement('p');
            messageText.classList.add('message-text');
            messageText.textContent = message.text;

            const timestamp = document.createElement('span');
            timestamp.classList.add('timestamp');
            const date = new Date(message.timestamp);
            timestamp.textContent = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

            messageElement.appendChild(senderInfo);
            messageElement.appendChild(messageText);
            messageElement.appendChild(timestamp);

            // Action buttons for delete and reply
            const messageActions = document.createElement('div');
            messageActions.classList.add('message-actions');

            // Reply button
            const replyBtn = document.createElement('button');
            replyBtn.textContent = 'Yanıtla';
            replyBtn.classList.add('reply-message-btn');
            replyBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Olayı durdur, profil modalının açılmasını engelle
                repliedMessageId = messageId;
                repliedMessageText = `${message.name || message.email.split('@')[0]}: ${message.text.substring(0, 30)}${message.text.length > 30 ? '...' : ''}`;
                replyToText.textContent = repliedMessageText;
                replyToBar.style.display = 'flex';
                chatMessageInput.focus();
            });
            messageActions.appendChild(replyBtn);

            // Delete button (only for sender or admin)
            if (currentUser && (message.uid === currentUser.uid || currentUserRank === "X-5")) {
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Sil';
                deleteBtn.classList.add('delete-message-btn');
                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation(); // Olayı durdur
                    if (confirm('Bu mesajı silmek istediğinizden emin misiniz?')) {
                        showLoadingScreen("Mesaj Siliniyor...");
                        try {
                            await database.ref('messages/' + messageId).remove();
                            messageElement.remove(); // UI'dan kaldır
                            showAlert('positive', 'Mesaj başarıyla silindi.', authStatusMessage);
                        } catch (error) {
                            showAlert('negative', 'Mesaj silinirken hata oluştu: ' + error.message, authStatusMessage);
                            console.error('Mesaj silme hatası:', error);
                        } finally {
                            hideLoadingScreen();
                        }
                    }
                });
                messageActions.appendChild(deleteBtn);
            }
            messageElement.appendChild(messageActions);

            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
        }

        sendMessageBtn.addEventListener('click', sendMessage);
        chatMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        cancelReplyBtn.addEventListener('click', () => {
            repliedMessageId = null;
            repliedMessageText = null;
            replyToBar.style.display = 'none';
        });

        async function sendMessage() {
            let messageText = chatMessageInput.value.trim();
            const user = auth.currentUser;

            if (!messageText || !user) return;

            showLoadingScreen("Mesaj İletiliyor...");
            try {
                // Fetch user's current specialty to include in the message
                const userSnapshot = await database.ref('users/' + user.uid).once('value');
                const userData = userSnapshot.val();
                const userSpecialty = userData ? userData.specialty : "Belirtilmemiş";

                const newMessageRef = database.ref('messages').push();
                await newMessageRef.set({
                    uid: user.uid,
                    email: user.email,
                    name: currentUserName,
                    specialty: userSpecialty, // Kullanıcının branşını ekle
                    rank: currentUserRank,
                    text: messageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    replyTo: repliedMessageId,
                    replyToText: repliedMessageText
                });

                chatMessageInput.value = '';
                repliedMessageId = null;
                repliedMessageText = null;
                replyToBar.style.display = 'none';
                hideLoadingScreen();
            } catch (error) {
                showAlert('negative', 'Mesaj gönderme hatası: ' + error.message, authStatusMessage);
                console.error('Mesaj gönderme hatası:', error);
                hideLoadingScreen();
            }
        }

        // --- Admin Panel Functions ---
        function loadUserManagement() {
            // Remove previous listeners to prevent duplicates
            if (activeListeners.userManagement) {
                database.ref('users').off('child_added', activeListeners.userManagement.callbackAdded);
                database.ref('users').off('child_changed', activeListeners.userManagement.callbackChanged);
                database.ref('users').off('child_removed', activeListeners.userManagement.callbackRemoved);
            }

            userManagementList.innerHTML = ''; // Clear existing list

            const callbackAdded = (snapshot) => {
                const userData = snapshot.val();
                const uid = snapshot.key;
                displayUserInAdminList(uid, userData);
            };
            const callbackChanged = (snapshot) => {
                const userData = snapshot.val();
                const uid = snapshot.key;
                updateUserInAdminList(uid, userData);
            };
            const callbackRemoved = (snapshot) => {
                const uid = snapshot.key;
                removeUserFromAdminList(uid);
            };

            database.ref('users').on('child_added', callbackAdded);
            database.ref('users').on('child_changed', callbackChanged);
            database.ref('users').on('child_removed', callbackRemoved);

            activeListeners.userManagement = {
                callbackAdded,
                callbackChanged,
                callbackRemoved
            };
        }

        function displayUserInAdminList(uid, userData) {
            // Eğer element zaten varsa güncelle, yoksa oluştur
            let userItem = userManagementList.querySelector(`li[data-uid="${uid}"]`);
            if (!userItem) {
                userItem = document.createElement('li');
                userItem.classList.add('user-item');
                userItem.dataset.uid = uid; // Store UID on the element
                userManagementList.appendChild(userItem);
            }

            const userInfoDiv = document.createElement('div');
            userInfoDiv.classList.add('user-info');
            userInfoDiv.innerHTML = `<span class="username">${userData.username || userData.email.split('@')[0]}</span> - ${userData.email} <span class="rank-display rank-${userData.rank.replace('-', '')}">[${userData.rank}]</span> (Uyarı: ${userData.warnings || 0})`;

            const userActionsDiv = document.createElement('div');
            userActionsDiv.classList.add('user-actions');

            // Rank Select
            const rankSelect = document.createElement('select');
            availableRanks.forEach(rank => {
                const option = document.createElement('option');
                option.value = rank;
                option.textContent = rank;
                if (rank === userData.rank) {
                    option.selected = true;
                }
                rankSelect.appendChild(option);
            });
            rankSelect.addEventListener('change', async (e) => {
                const newRank = e.target.value;
                if (confirm(`${userData.username} kullanıcısının rütbesini ${newRank} olarak değiştirmek istediğinizden emin misiniz?`)) {
                    showLoadingScreen("Rütbe Güncelleniyor...");
                    try {
                        await database.ref('users/' + uid).update({ rank: newRank });
                        showAlert('positive', `${userData.username} kullanıcısının rütbesi güncellendi!`, announcementStatusMessage);
                    } catch (error) {
                        showAlert('negative', `Rütbe güncellenirken hata: ${error.message}`, announcementStatusMessage);
                        console.error('Rank update error:', error);
                    } finally {
                        hideLoadingScreen();
                    }
                } else {
                    e.target.value = userData.rank; // Değişikliği geri al
                }
            });
            userActionsDiv.appendChild(rankSelect);

            // Send Warning Button
            const warnBtn = document.createElement('button');
            warnBtn.textContent = 'Uyarı Gönder';
            warnBtn.addEventListener('click', async () => {
                const warningMessage = prompt(`"${userData.username}" kullanıcısına gönderilecek uyarı mesajını girin:`);
                if (warningMessage) {
                    showLoadingScreen("Uyarı Gönderiliyor...");
                    try {
                        // Kullanıcının uyarı sayısını artır
                        const newWarningCount = (userData.warnings || 0) + 1;
                        await database.ref(`users/${uid}/warnings`).set(newWarningCount);
                        // Uyarıyı kaydet
                        await database.ref(`warnings/${uid}`).push({
                            message: warningMessage,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            sentBy: auth.currentUser.uid
                        });
                        showAlert('positive', `${userData.username} kullanıcısına uyarı gönderildi!`, announcementStatusMessage);
                    } catch (error) {
                        showAlert('negative', `Uyarı gönderilirken hata: ${error.message}`, announcementStatusMessage);
                        console.error('Warning send error:', error);
                    } finally {
                        hideLoadingScreen();
                    }
                }
            });
            userActionsDiv.appendChild(warnBtn);


            // Delete User Button
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Sil';
            deleteBtn.addEventListener('click', async () => {
                if (confirm(`${userData.username} kullanıcısını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!`)) {
                    showLoadingScreen("Kullanıcı Siliniyor...");
                    try {
                        // Sadece Realtime DB'den kullanıcı verisini sil.
                        // Firebase Authentication'daki kullanıcıyı silmek için sunucu tarafı bir çözüm (Firebase Admin SDK) gereklidir.
                        // Frontend'den doğrudan Auth kullanıcısı silmek güvenlik açığı yaratabilir.
                        await database.ref('users/' + uid).remove();
                        // İlgili mesajları, arkadaşlıkları, uyarıları vb. de silebiliriz.
                        await database.ref('friendRequests').once('value', (snapshot) => {
                            snapshot.forEach(receiverSnap => {
                                if (receiverSnap.child(uid).exists()) {
                                    database.ref(`friendRequests/${receiverSnap.key}/${uid}`).remove();
                                }
                            });
                        });
                        await database.ref(`warnings/${uid}`).remove();

                        showAlert('positive', `${userData.username} kullanıcısı veritabanından silindi.`, announcementStatusMessage);
                    } catch (error) {
                        showAlert('negative', `Kullanıcı silinirken hata: ${error.message}`, announcementStatusMessage);
                        console.error('User delete error:', error);
                    } finally {
                        hideLoadingScreen();
                    }
                }
            });
            userActionsDiv.appendChild(deleteBtn);

            userItem.innerHTML = ''; // İçeriği temizle
            userItem.appendChild(userInfoDiv);
            userItem.appendChild(userActionsDiv);
        }


        function updateUserInAdminList(uid, updatedUserData) {
            const userItem = userManagementList.querySelector(`li[data-uid="${uid}"]`);
            if (userItem) {
                const userInfoDiv = userItem.querySelector('.user-info');
                userInfoDiv.innerHTML = `<span class="username">${updatedUserData.username || updatedUserData.email.split('@')[0]}</span> - ${updatedUserData.email} <span class="rank-display rank-${updatedUserData.rank.replace('-', '')}">[${updatedUserData.rank}]</span> (Uyarı: ${updatedUserData.warnings || 0})`;

                const rankSelect = userItem.querySelector('select');
                if (rankSelect) {
                    rankSelect.value = updatedUserData.rank;
                }
            }
        }

        function removeUserFromAdminList(uid) {
            const userItem = userManagementList.querySelector(`li[data-uid="${uid}"]`);
            if (userItem) {
                userItem.remove();
            }
        }

        // --- Announcement System (Admin Panel) ---
        publishAnnouncementBtn.addEventListener('click', async () => {
            const announcementContent = announcementTextArea.value.trim();
            if (!announcementContent) {
                showAlert('negative', 'Duyuru içeriği boş olamaz.', announcementStatusMessage);
                return;
            }

            showLoadingScreen("Duyuru Yayınlanıyor...");
            try {
                // Sadece tek bir aktif duyuru olması için eskiyi silip yenisini ekle
                const announcementsRef = database.ref('announcements');
                await announcementsRef.remove(); // Tüm eski duyuruları sil

                const newAnnouncementRef = announcementsRef.push();
                await newAnnouncementRef.set({
                    content: announcementContent,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    publishedBy: auth.currentUser.uid
                });

                showAlert('positive', 'Duyuru başarıyla yayınlandı!', announcementStatusMessage);
                announcementTextArea.value = '';
            } catch (error) {
                showAlert('negative', 'Duyuru yayınlanırken hata oluştu: ' + error.message, announcementStatusMessage);
                console.error('Announcement publish error:', error);
            } finally {
                hideLoadingScreen();
            }
        });

        async function loadLatestAnnouncementForAdmin() {
            const snapshot = await database.ref('announcements').limitToLast(1).once('value');
            if (snapshot.exists()) {
                const latestAnnouncement = Object.values(snapshot.val())[0]; // İlk ve tek duyuruyu al
                announcementTextArea.value = latestAnnouncement.content;
            } else {
                announcementTextArea.value = '';
            }
        }


        // --- Announcement System (User Side) ---
        async function checkAndDisplayAnnouncement(userUid) {
            const announcementsRef = database.ref('announcements');
            const userReadAnnouncementsRef = database.ref(`users/${userUid}/readAnnouncements`);

            // Check for unread announcements
            if (activeListeners.announcement) {
                announcementsRef.off('child_added', activeListeners.announcement.callback);
            }

            const announcementCallback = async (snapshot) => {
                const announcementId = snapshot.key;
                const announcementData = snapshot.val();

                const readSnapshot = await userReadAnnouncementsRef.child(announcementId).once('value');
                if (!readSnapshot.exists() || readSnapshot.val() === false) { // Eğer okundu olarak işaretlenmediyse
                    currentAnnouncementId = announcementId;
                    announcementText.textContent = announcementData.content;
                    announcementModal.classList.add('active');
                }
            };
            announcementsRef.limitToLast(1).on('child_added', announcementCallback);
            activeListeners.announcement = { callback: announcementCallback };
        }

        markAnnouncementReadBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user && currentAnnouncementId) {
                showLoadingScreen("Duyuru İşaretleniyor...");
                try {
                    await database.ref(`users/${user.uid}/readAnnouncements/${currentAnnouncementId}`).set(true);
                    announcementModal.classList.remove('active');
                } catch (error) {
                    showAlert('negative', 'Duyuru okundu olarak işaretlenirken hata oluştu: ' + error.message, authStatusMessage);
                    console.error('Mark announcement read error:', error);
                } finally {
                    hideLoadingScreen();
                    currentAnnouncementId = null; // Duyuru ID'sini sıfırla
                }
            }
        });

        announcementModalCloseBtn.addEventListener('click', () => {
            announcementModal.classList.remove('active');
            // Kullanıcı kapatırsa da okundu sayabiliriz veya bu seçeneği devre dışı bırakabiliriz.
            // Şimdilik sadece kapatıyoruz, tekrar açılabilir. Okundu butonu daha net bir eylem.
        });


        // --- Warning System (User Side) ---
        function listenForWarnings(userUid) {
            if (activeListeners.warnings) {
                database.ref(`warnings/${userUid}`).off('child_added', activeListeners.warnings.added);
            }

            const warningAddedCallback = async (snapshot) => {
                const warningData = snapshot.val();
                if (warningData.message) {
                    displayWarningOverlay(warningData.message);
                }
            };

            database.ref(`warnings/${userUid}`).on('child_added', warningAddedCallback);
            activeListeners.warnings = { added: warningAddedCallback };

            // Kullanıcının warnings sayısını da dinle ve profil ekranını güncelle
            database.ref(`users/${userUid}/warnings`).on('value', (snapshot) => {
                const newWarningCount = snapshot.val() || 0;
                currentUserWarnings = newWarningCount;
                profileWarningsCount.textContent = `Uyarı Sayısı: ${newWarningCount}`;
                if (modalProfileWarningsCount) { // Modal açıksa onu da güncelle
                    modalProfileWarningsCount.textContent = `Uyarı Sayısı: ${newWarningCount}`;
                }
            });
        }

        function displayWarningOverlay(message) {
            warningMessageText.textContent = message;
            warningOverlay.classList.add('active');
        }

        warningCloseBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                // Uyarıyı okundu olarak işaretlemek için silebiliriz, veya özel bir düğümde tutabiliriz.
                // Basitlik için, kullanıcı "Anlaşıldı" dediğinde o anki uyarıyı siliyoruz.
                // Gerçek bir sistemde daha sofistike bir yaklaşım gerekebilir (örn: uyarı geçmişi, okundu bilgisi).
                // En son uyarıyı bulup sil.
                try {
                    const lastWarningSnapshot = await database.ref(`warnings/${user.uid}`).limitToLast(1).once('value');
                    if (lastWarningSnapshot.exists()) {
                        const warningIdToRemove = Object.keys(lastWarningSnapshot.val())[0];
                        await database.ref(`warnings/${user.uid}/${warningIdToRemove}`).remove();
                    }
                } catch (error) {
                    console.error('Uyarı silinirken hata:', error);
                }
            }
            warningOverlay.classList.remove('active');
        });


        // --- Navigation ---
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                if (!auth.currentUser && item.id !== 'logout-btn') { // Sadece giriş yapanlar için diğer sayfalar
                    showAlert('negative', 'Bu sayfaya erişmek için giriş yapmalısınız.', authStatusMessage);
                    return;
                }
                if (item.id === 'logout-btn') return; // Logout butonu ayrı ele alınır

                const targetScreenId = item.dataset.screen;
                if (targetScreenId) {
                    showLoadingScreen("Ekran Yükleniyor...");
                    // Küçük bir gecikme ekleyerek animasyonun görünmesini sağla
                    setTimeout(() => {
                        showScreen(targetScreenId);
                        hideLoadingScreen();
                    }, 500); // 500ms (yarım saniye) gecikme
                }
            });
        });

        logo.addEventListener('click', () => {
            if (auth.currentUser) {
                showLoadingScreen("Ana Ekran Yükleniyor...");
                setTimeout(() => {
                    showScreen('chat-screen');
                    hideLoadingScreen();
                }, 500);
            } else {
                showAlert('positive', 'Lütfen giriş yapın.', authStatusMessage);
            }
        });

        // --- Profile Modal Functions ---
        chatMessages.addEventListener('click', async (e) => {
            const messageElement = e.target.closest('.message');
            if (!messageElement) return;

            const senderUid = messageElement.dataset.senderUid;
            if (!senderUid) return;

            // Eğer action butonlarından birine tıklandıysa, profil modalını açma
            if (e.target.classList.contains('delete-message-btn') || e.target.classList.contains('reply-message-btn')) {
                return;
            }

            if (auth.currentUser && senderUid === auth.currentUser.uid) {
                showAlert('positive', 'Bu sizin profiliniz. Ayarlar bölümünden düzenleyebilirsiniz.', authStatusMessage);
                return;
            }
            showLoadingScreen("Profil Verileri Alınıyor...");
            try {
                await openProfileModal(senderUid);
            } catch (error) {
                showAlert('negative', 'Profil yüklenirken hata oluştu: ' + error.message, authStatusMessage);
                console.error('Profil yükleme hatası:', error);
            } finally {
                hideLoadingScreen();
            }
        });

        profileModalCloseBtn.addEventListener('click', () => {
            profileModal.classList.remove('active');
        });

        // Modal dışına tıklayınca kapatma
        window.addEventListener('click', (event) => {
            if (event.target === profileModal) {
                profileModal.classList.remove('active');
            }
            if (event.target === announcementModal) {
                announcementModal.classList.remove('active');
            }
            if (event.target === privateChatModal) {
                privateChatModal.classList.remove('active');
            }
            // Warning overlay'i sadece kendi butonu ile kapanmalı
        });

        async function openProfileModal(uid) {
            targetUserUid = uid; // Profilini açtığımız kişinin UID'sini sakla

            const userRef = database.ref('users/' + uid);
            const snapshot = await userRef.once('value');
            const userData = snapshot.val();

            if (userData) {
                modalProfileUsername.textContent = userData.username || userData.email.split('@')[0];
                modalProfileSpecialty.textContent = `Branş: ${userData.specialty || 'Belirtilmemiş'}`;
                modalProfileRank.textContent = `Rütbe: ${userData.rank}`;
                modalProfileWarningsCount.textContent = `Uyarı Sayısı: ${userData.warnings || 0}`; // Uyarı sayısı
                document.querySelector('.modal-profile-pic').src = `https://via.placeholder.com/80/004D40/00EEFF?text=${(userData.username ? userData.username.charAt(0) : userData.email.charAt(0)).toUpperCase()}`;

                await checkFriendshipStatus(uid); // Arkadaşlık durumunu kontrol et
                profileModal.classList.add('active');
            } else {
                showAlert('negative', 'Kullanıcı bilgileri bulunamadı.', authStatusMessage);
            }
        }

        // --- Friendship System ---
        addFriendBtn.addEventListener('click', async () => {
            const currentUser = auth.currentUser;
            if (!currentUser) {
                showAlert('negative', 'Bu işlemi yapmak için giriş yapmalısınız.', authStatusMessage);
                return;
            }
            if (!targetUserUid) return;

            if (currentUser.uid === targetUserUid) {
                showAlert('negative', 'Kendinize arkadaşlık isteği gönderemezsiniz.', authStatusMessage);
                return;
            }

            const friendRequestRef = database.ref(`friendRequests/${targetUserUid}/${currentUser.uid}`); // Alıcıya gönderen
            const myFriendsRef = database.ref(`users/${currentUser.uid}/friends/${targetUserUid}`); // Benim arkadaş listem
            const reverseRequestRef = database.ref(`friendRequests/${currentUser.uid}/${targetUserUid}`); // Bana gönderilen

            showLoadingScreen("Arkadaşlık Durumu Kontrol Ediliyor...");
            try {
                // 1. Zaten arkadaş olup olmadığını kontrol et
                const isFriendSnapshot = await myFriendsRef.once('value');
                if (isFriendSnapshot.exists() && isFriendSnapshot.val() === true) {
                    showAlert('negative', 'Bu kullanıcı zaten arkadaşınız.', authStatusMessage);
                    hideLoadingScreen();
                    return;
                }

                // 2. Bekleyen istek durumu (ben gönderdim)
                const existingRequestSnapshot = await friendRequestRef.once('value');
                if (existingRequestSnapshot.exists() && existingRequestSnapshot.val().status === 'pending') {
                    showAlert('negative', 'Bu kullanıcıya zaten bir arkadaşlık isteği gönderdiniz.', authStatusMessage);
                    hideLoadingScreen();
                    return;
                }

                // 3. Bekleyen istek durumu (bana gönderildi) - Eğer varsa kabul et
                const reverseRequestSnapshot = await reverseRequestRef.once('value');
                if (reverseRequestSnapshot.exists() && reverseRequestSnapshot.val().status === 'pending') {
                    await acceptFriendRequest(targetUserUid); // Bu fonksiyon zaten loading ekranı kullanır.
                    // İşlem tamamlandığında butonu günceller ve loading ekranını kapatır.
                    return;
                }

                // Eğer hiçbiri yoksa, yeni istek gönder
                showLoadingScreen("Arkadaşlık İsteği Gönderiliyor...");
                await friendRequestRef.set({
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    senderUsername: currentUserName // Gönderen adını kaydet
                });
                showAlert('positive', `${modalProfileUsername.textContent} kişisine arkadaşlık isteği gönderildi.`, authStatusMessage);
                addFriendBtn.textContent = "İstek Gönderildi";
                addFriendBtn.disabled = true;
            } catch (error) {
                showAlert('negative', 'Arkadaşlık isteği gönderilirken hata oluştu: ' + error.message, authStatusMessage);
                console.error('Arkadaşlık isteği hatası:', error);
            } finally {
                hideLoadingScreen();
            }
        });

        async function checkFriendshipStatus(targetUid) {
            const currentUser = auth.currentUser;
            if (!currentUser) {
                addFriendBtn.style.display = 'none';
                return;
            }

            addFriendBtn.style.display = 'block';
            addFriendBtn.disabled = false;
            addFriendBtn.textContent = "Arkadaş Ekle";

            if (currentUser.uid === targetUid) {
                addFriendBtn.style.display = 'none';
                return;
            }

            const myFriendsRef = database.ref(`users/${currentUser.uid}/friends/${targetUid}`);
            const isFriendSnapshot = await myFriendsRef.once('value');
            if (isFriendSnapshot.exists() && isFriendSnapshot.val() === true) {
                addFriendBtn.textContent = "Arkadaşınız";
                addFriendBtn.disabled = true;
                return;
            }

            const requestSentRef = database.ref(`friendRequests/${targetUid}/${currentUser.uid}`);
            const requestSentSnapshot = await requestSentRef.once('value');
            if (requestSentSnapshot.exists() && requestSentSnapshot.val().status === 'pending') {
                addFriendBtn.textContent = "İstek Gönderildi";
                addFriendBtn.disabled = true;
                return;
            }

            const requestReceivedRef = database.ref(`friendRequests/${currentUser.uid}/${targetUid}`);
            const requestReceivedSnapshot = await requestReceivedRef.once('value');
            if (requestReceivedSnapshot.exists() && requestReceivedSnapshot.val().status === 'pending') {
                addFriendBtn.textContent = "İsteği Kabul Et";
                // Butonun click event'i zaten addFriendBtn listener'ı içinde yönetiliyor.
                // Bu durumda, addFriendBtn tıklandığında bu durum zaten kontrol edilecek ve acceptFriendRequest çağrılacak.
                return;
            }
        }

        async function acceptFriendRequest(senderUid) {
            const currentUser = auth.currentUser;
            if (!currentUser || !senderUid) return;

            showLoadingScreen("Arkadaşlık Kabul Ediliyor...");
            try {
                // İsteği 'accepted' olarak güncelle
                await database.ref(`friendRequests/${currentUser.uid}/${senderUid}`).update({ status: 'accepted' });

                // İki tarafı da arkadaş olarak ekle
                await database.ref(`users/${currentUser.uid}/friends/${senderUid}`).set(true);
                await database.ref(`users/${senderUid}/friends/${currentUser.uid}`).set(true);

                // Ortak özel sohbet odası oluştur (veya varolanı kullan)
                const chatId = getPrivateChatId(currentUser.uid, senderUid);
                await database.ref(`privateChats/${chatId}/members`).set({
                    [currentUser.uid]: true,
                    [senderUid]: true
                });

                showAlert('positive', `${(await getUserData(senderUid)).username || 'Kullanıcı'} artık arkadaşınız.`, authStatusMessage);
                if (targetUserUid === senderUid) { // Eğer profil modalından kabul edildiyse
                    addFriendBtn.textContent = "Arkadaşınız";
                    addFriendBtn.disabled = true;
                }
                // FriendRequests listesini güncelle
                loadFriendsAndRequests();
            } catch (error) {
                showAlert('negative', 'Arkadaşlık isteği kabul edilirken hata oluştu: ' + error.message, authStatusMessage);
                console.error('Arkadaşlık kabul hatası:', error);
            } finally {
                hideLoadingScreen();
            }
        }

        async function rejectFriendRequest(senderUid) {
            const currentUser = auth.currentUser;
            if (!currentUser || !senderUid) return;

            showLoadingScreen("İstek Reddediliyor...");
            try {
                await database.ref(`friendRequests/${currentUser.uid}/${senderUid}`).remove();
                showAlert('positive', 'Arkadaşlık isteği reddedildi.', authStatusMessage);
                loadFriendsAndRequests(); // Listeyi güncelle
            } catch (error) {
                showAlert('negative', 'Arkadaşlık isteği reddedilirken hata oluştu: ' + error.message, authStatusMessage);
                console.error('Arkadaşlık reddetme hatası:', error);
            } finally {
                hideLoadingScreen();
            }
        }

        async function removeFriend(friendUid) {
            const currentUser = auth.currentUser;
            if (!currentUser || !friendUid) return;

            if (confirm(`${(await getUserData(friendUid)).username || 'Bu kullanıcıyı'} arkadaşlarınızdan çıkarmak istediğinizden emin misiniz?`)) {
                showLoadingScreen("Arkadaş Kaldırılıyor...");
                try {
                    await database.ref(`users/${currentUser.uid}/friends/${friendUid}`).remove();
                    await database.ref(`users/${friendUid}/friends/${currentUser.uid}`).remove();

                    // Ortak özel sohbet odasını kaldır
                    const chatId = getPrivateChatId(currentUser.uid, friendUid);
                    await database.ref(`privateChats/${chatId}`).remove();

                    showAlert('positive', 'Arkadaş başarıyla kaldırıldı.', authStatusMessage);
                    loadFriendsAndRequests(); // Listeyi güncelle
                } catch (error) {
                    showAlert('negative', 'Arkadaş kaldırılırken hata oluştu: ' + error.message, authStatusMessage);
                    console.error('Arkadaş kaldırma hatası:', error);
                } finally {
                    hideLoadingScreen();
                }
            }
        }


        // --- Friends List & Requests Display ---
        async function loadFriendsAndRequests() {
            const currentUser = auth.currentUser;
            if (!currentUser) return;

            friendsList.innerHTML = '';
            friendRequestsList.innerHTML = '';
            privateRoomsList.innerHTML = '';

            // Listen for friend requests
            if (activeListeners.friendRequests) {
                database.ref(`friendRequests/${currentUser.uid}`).off('child_added', activeListeners.friendRequests.added);
                database.ref(`friendRequests/${currentUser.uid}`).off('child_removed', activeListeners.friendRequests.removed);
            }

            const requestAddedCallback = async (snapshot) => {
                const requestData = snapshot.val();
                const senderUid = snapshot.key;
                if (requestData.status === 'pending') {
                    const senderData = (await database.ref(`users/${senderUid}`).once('value')).val();
                    displayFriendRequest(senderUid, senderData);
                    hasNewFriendRequests = true;
                    updateFriendRequestNotification();
                }
            };
            const requestRemovedCallback = (snapshot) => {
                const senderUid = snapshot.key;
                removeFriendRequestFromList(senderUid);
                // Kontrol et, hala bekleyen istek var mı?
                database.ref(`friendRequests/${currentUser.uid}`).once('value', (s) => {
                    hasNewFriendRequests = false;
                    s.forEach(child => {
                        if (child.val().status === 'pending') {
                            hasNewFriendRequests = true;
                        }
                    });
                    updateFriendRequestNotification();
                });
            };

            database.ref(`friendRequests/${currentUser.uid}`).on('child_added', requestAddedCallback);
            database.ref(`friendRequests/${currentUser.uid}`).on('child_removed', requestRemovedCallback);
            activeListeners.friendRequests = { added: requestAddedCallback, removed: requestRemovedCallback };


            // Listen for friends
            if (activeListeners.friendsList) {
                database.ref(`users/${currentUser.uid}/friends`).off('child_added', activeListeners.friendsList.added);
                database.ref(`users/${currentUser.uid}/friends`).off('child_removed', activeListeners.friendsList.removed);
            }

            const friendAddedCallback = async (snapshot) => {
                const friendUid = snapshot.key;
                const friendData = (await database.ref(`users/${friendUid}`).once('value')).val();
                displayFriend(friendUid, friendData);
                // Arkadaşın online durumunu da dinle
                listenForFriendOnlineStatus(friendUid);
                // Özel sohbet odasını da listeye ekle
                const chatId = getPrivateChatId(currentUser.uid, friendUid);
                displayPrivateRoom(chatId, friendUid, friendData.username || friendData.email.split('@')[0]);
            };
            const friendRemovedCallback = (snapshot) => {
                const friendUid = snapshot.key;
                removeFriendFromList(friendUid);
                // Arkadaşın online durum dinleyicisini kaldır
                if (activeListeners[`onlineStatus-${friendUid}`]) {
                    database.ref(`onlineUsers/${friendUid}`).off('value', activeListeners[`onlineStatus-${friendUid}`].callback);
                    activeListeners[`onlineStatus-${friendUid}`] = null;
                }
                // Özel sohbet odasını da kaldır
                removePrivateRoomFromList(getPrivateChatId(currentUser.uid, friendUid));
            };

            database.ref(`users/${currentUser.uid}/friends`).on('child_added', friendAddedCallback);
            database.ref(`users/${currentUser.uid}/friends`).on('child_removed', friendRemovedCallback);
            activeListeners.friendsList = { added: friendAddedCallback, removed: friendRemovedCallback };
        }

        function displayFriendRequest(senderUid, senderData) {
            const requestItem = document.createElement('li');
            requestItem.classList.add('request-item');
            requestItem.dataset.uid = senderUid;

            const requestInfo = document.createElement('div');
            requestInfo.classList.add('request-info');
            requestInfo.innerHTML = `<span class="username">${senderData.username || senderData.email.split('@')[0]}</span> <span class="rank-display rank-${senderData.rank.replace('-', '')}">[${senderData.rank}]</span> senden bir istek yolladı.`;

            const requestActions = document.createElement('div');
            requestActions.classList.add('request-actions');

            const acceptBtn = document.createElement('button');
            acceptBtn.textContent = 'Kabul Et';
            acceptBtn.classList.add('accept-btn');
            acceptBtn.addEventListener('click', () => acceptFriendRequest(senderUid));
            requestActions.appendChild(acceptBtn);

            const rejectBtn = document.createElement('button');
            rejectBtn.textContent = 'Reddet';
            rejectBtn.classList.add('reject-btn');
            rejectBtn.addEventListener('click', () => rejectFriendRequest(senderUid));
            requestActions.appendChild(rejectBtn);

            requestItem.appendChild(requestInfo);
            requestItem.appendChild(requestActions);
            friendRequestsList.appendChild(requestItem);
        }

        function removeFriendRequestFromList(uid) {
            const item = friendRequestsList.querySelector(`li[data-uid="${uid}"]`);
            if (item) item.remove();
        }

        async function displayFriend(friendUid, friendData) {
            const friendItem = document.createElement('li');
            friendItem.classList.add('friend-item');
            friendItem.dataset.uid = friendUid;

            const friendInfo = document.createElement('div');
            friendInfo.classList.add('friend-info');
            friendInfo.addEventListener('click', () => openProfileModal(friendUid));

            const onlineDot = document.createElement('span');
            onlineDot.classList.add('online-status-dot', 'offline'); // Varsayılan olarak offline
            onlineDot.id = `online-dot-${friendUid}`;
            friendInfo.appendChild(onlineDot);

            friendInfo.innerHTML += `<span class="username">${friendData.username || friendData.email.split('@')[0]}</span> <span class="rank-display rank-${friendData.rank.replace('-', '')}">[${friendData.rank}]</span>`;

            const friendActions = document.createElement('div');
            friendActions.classList.add('friend-actions');

            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Sil';
            removeBtn.classList.add('remove-friend-btn');
            removeBtn.addEventListener('click', () => removeFriend(friendUid));
            friendActions.appendChild(removeBtn);

            friendItem.appendChild(friendInfo);
            friendItem.appendChild(friendActions);
            friendsList.appendChild(friendItem);
        }

        function removeFriendFromList(uid) {
            const item = friendsList.querySelector(`li[data-uid="${uid}"]`);
            if (item) item.remove();
        }

        // --- Online Status for Friends ---
        function listenForFriendOnlineStatus(friendUid) {
            // Önceki dinleyiciyi kaldır
            if (activeListeners[`onlineStatus-${friendUid}`]) {
                database.ref(`onlineUsers/${friendUid}`).off('value', activeListeners[`onlineStatus-${friendUid}`].callback);
            }

            const callback = (snapshot) => {
                const onlineDot = document.getElementById(`online-dot-${friendUid}`);
                if (onlineDot) {
                    if (snapshot.exists()) {
                        onlineDot.classList.remove('offline');
                        onlineDot.classList.add('online');
                    } else {
                        onlineDot.classList.remove('online');
                        onlineDot.classList.add('offline');
                    }
                }
            };
            database.ref(`onlineUsers/${friendUid}`).on('value', callback);
            activeListeners[`onlineStatus-${friendUid}`] = { callback: callback }; // Referansı sakla
        }


        // --- Private Chat System ---
        sendPrivateMessageBtn.addEventListener('click', async () => {
            // Profil modalından tetiklenen buton
            if (!auth.currentUser) {
                showAlert('negative', 'Bu işlemi yapmak için giriş yapmalısınız.', authStatusMessage);
                return;
            }
            if (!targetUserUid) {
                showAlert('negative', 'Özel mesaj gönderilecek kullanıcı bulunamadı.', authStatusMessage);
                return;
            }

            showLoadingScreen("Özel Sohbet Hazırlanıyor...");
            try {
                // Hedef kullanıcının profil adını al
                const userData = (await getUserData(targetUserUid));
                currentPrivateChatTargetUsername = userData ? (userData.username || userData.email.split('@')[0]) : "Bilinmeyen Kullanıcı";

                profileModal.classList.remove('active'); // Profil modalını kapat
                await openPrivateChat(auth.currentUser.uid, targetUserUid, currentPrivateChatTargetUsername);
            } catch (error) {
                showAlert('negative', 'Özel sohbet açılamadı: ' + error.message, authStatusMessage);
                console.error('Özel sohbet açma hatası:', error);
            } finally {
                hideLoadingScreen();
            }
        });

        sendPrivateMessageBtnModal.addEventListener('click', sendPrivateMessage);
        privateMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendPrivateMessage();
            }
        });

        function getPrivateChatId(uid1, uid2) {
            // Her zaman daha küçük UID'yi öne alarak benzersiz bir ID oluştur
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        async function openPrivateChat(user1Uid, user2Uid, targetUsername) {
            currentPrivateChatId = getPrivateChatId(user1Uid, user2Uid);
            currentPrivateChatTargetUsername = targetUsername;
            privateChatHeader.textContent = `Özel Sohbet: ${targetUsername}`;
            privateChatMessages.innerHTML = ''; // Önceki mesajları temizle

            // Eski dinleyiciyi kapat
            if (activeListeners.currentPrivateChatListener) {
                database.ref(`privateChats/${currentPrivateChatId}/messages`).off('child_added', activeListeners.currentPrivateChatListener.callback);
            }

            // Yeni dinleyiciyi kur (son 50 mesajı al)
            const privateChatCallback = async (snapshot) => {
                const message = snapshot.val();
                await displayPrivateMessage(message); // Async olarak mesajı göster
                privateChatMessages.scrollTop = privateChatMessages.scrollHeight; // En alta kaydır
                // Mesajı görüldü olarak işaretle
                if (auth.currentUser && message.senderUid !== auth.currentUser.uid) {
                    await database.ref(`privateChats/${currentPrivateChatId}/lastSeen/${auth.currentUser.uid}`).set(firebase.database.ServerValue.TIMESTAMP);
                }
            };
            database.ref(`privateChats/${currentPrivateChatId}/messages`).limitToLast(50).on('child_added', privateChatCallback);
            activeListeners.currentPrivateChatListener = { callback: privateChatCallback };


            privateChatModal.classList.add('active');
            // Yeni mesaj bildirimini kapat (eğer bu sohbetle ilgiliyse)
            hasNewPrivateMessages = false;
            updateFriendRequestNotification(); // Genel bildirim göstergesini güncelle
        }

        async function displayPrivateMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            const currentUser = auth.currentUser;
            if (currentUser && message.senderUid === currentUser.uid) {
                messageElement.classList.add('sent');
            } else {
                messageElement.classList.add('received');
            }

            // Gönderenin kullanıcı adını Firebase'den çek (veya mesajla birlikte kaydet)
            const senderData = await getUserData(message.senderUid);
            const senderName = senderData ? (senderData.username || senderData.email.split('@')[0]) : 'Bilinmeyen';

            const senderInfo = document.createElement('span');
            senderInfo.classList.add('sender-info');
            senderInfo.textContent = `${senderName}:`;

            const messageText = document.createElement('p');
            messageText.classList.add('message-text');
            messageText.textContent = message.text;

            const timestamp = document.createElement('span');
            timestamp.classList.add('timestamp');
            const date = new Date(message.timestamp);
            timestamp.textContent = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

            messageElement.appendChild(senderInfo);
            messageElement.appendChild(messageText);
            messageElement.appendChild(timestamp);
            privateChatMessages.appendChild(messageElement);
        }

        async function sendPrivateMessage() {
            const messageText = privateMessageInput.value.trim();
            const currentUser = auth.currentUser;

            if (!messageText || !currentUser || !currentPrivateChatId) return;

            showLoadingScreen("Özel Mesaj İletiliyor...");
            try {
                await database.ref(`privateChats/${currentPrivateChatId}/messages`).push({
                    senderUid: currentUser.uid,
                    text: messageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                // Kendi mesajımızı gönderdiğimiz için son görülme zamanımızı da güncelle
                await database.ref(`privateChats/${currentPrivateChatId}/lastSeen/${currentUser.uid}`).set(firebase.database.ServerValue.TIMESTAMP);
                privateMessageInput.value = '';
            } catch (error) {
                showAlert('negative', 'Özel mesaj gönderilirken hata oluştu: ' + error.message, authStatusMessage);
                console.error('Özel mesaj gönderme hatası:', error);
            } finally {
                hideLoadingScreen();
            }
        }

        privateChatCloseBtn.addEventListener('click', () => {
            privateChatModal.classList.remove('active');
            // Özel sohbet dinleyicisini kapat
            if (activeListeners.currentPrivateChatListener) {
                database.ref(`privateChats/${currentPrivateChatId}/messages`).off('child_added', activeListeners.currentPrivateChatListener.callback);
                activeListeners.currentPrivateChatListener = null;
            }
            currentPrivateChatId = null;
            currentPrivateChatTargetUsername = null;
        });

        // --- Utility for getting User Data ---
        async function getUserData(uid) {
            const snapshot = await database.ref(`users/${uid}`).once('value');
            return snapshot.val();
        }

        // --- Private Room Listing ---
        async function displayPrivateRoom(chatId, friendUid, friendUsername) {
            // Check if the room already exists to prevent duplicates on re-render
            if (document.getElementById(`private-room-${chatId}`)) {
                return;
            }

            const roomItem = document.createElement('li');
            roomItem.classList.add('private-room-item');
            roomItem.id = `private-room-${chatId}`;
            roomItem.dataset.chatId = chatId;
            roomItem.dataset.friendUid = friendUid;

            const roomInfo = document.createElement('div');
            roomInfo.classList.add('private-room-info');
            roomInfo.innerHTML = `<span class="room-name">Sohbet: ${friendUsername}</span>`;
            roomInfo.addEventListener('click', async () => {
                showLoadingScreen(`"${friendUsername}" ile bağlantı kuruluyor...`);
                await openPrivateChat(auth.currentUser.uid, friendUid, friendUsername);
                hideLoadingScreen();
            });

            const roomActions = document.createElement('div');
            roomActions.classList.add('private-room-actions');
            const newMsgIndicator = document.createElement('span');
            newMsgIndicator.classList.add('notification-indicator');
            newMsgIndicator.style.display = 'none';
            newMsgIndicator.textContent = '1'; // Sadece varlığını gösterir, sayıyı başka yerde güncelleyebiliriz
            newMsgIndicator.id = `private-msg-notification-${chatId}`;
            roomActions.appendChild(newMsgIndicator);


            roomItem.appendChild(roomInfo);
            roomItem.appendChild(roomActions);
            privateRoomsList.appendChild(roomItem);

            // Yeni mesajları dinle
            listenForNewPrivateMessages(chatId, friendUid);
        }

        function removePrivateRoomFromList(chatId) {
            const item = document.getElementById(`private-room-${chatId}`);
            if (item) item.remove();
        }

        // --- Notifications ---
        function setupNotifications(currentUserUid) {
            // Arkadaşlık isteği bildirimleri
            if (activeListeners.friendRequestNotification) {
                database.ref(`friendRequests/${currentUserUid}`).off('value', activeListeners.friendRequestNotification.callback);
            }
            const frNotificationCallback = (snapshot) => {
                hasNewFriendRequests = false;
                snapshot.forEach(child => {
                    if (child.val().status === 'pending') {
                        hasNewFriendRequests = true;
                    }
                });
                updateFriendRequestNotification();
            };
            database.ref(`friendRequests/${currentUserUid}`).on('value', frNotificationCallback);
            activeListeners.friendRequestNotification = { callback: frNotificationCallback };

            // Yeni özel mesaj bildirimleri (her sohbet odası için ayrı ayrı)
            // Bu kısım loadFriendsAndRequests içinde displayPrivateRoom çağrılırken ele alınıyor.
            // Zaten arkadaş olunan her kişi için özel sohbet ID'si oluşturulup dinleyici kurulacak.
        }

        async function listenForNewPrivateMessages(chatId, friendUid) {
            const currentUserUid = auth.currentUser.uid;
            const messagesRef = database.ref(`privateChats/${chatId}/messages`);
            const lastSeenRef = database.ref(`privateChats/${chatId}/lastSeen/${currentUserUid}`);

            // Son görülme zamanını al
            let lastSeenTimestamp = (await lastSeenRef.once('value')).val() || 0;

            // Her yeni mesaj geldiğinde tetiklenecek
            const messageCallback = (snapshot) => {
                const message = snapshot.val();
                // Eğer mesaj ben göndermediysem VE timestamp benim son görülme zamanımdan yeniyse
                if (message.senderUid !== currentUserUid && message.timestamp > lastSeenTimestamp) {
                    hasNewPrivateMessages = true;
                    updateFriendRequestNotification(); // Genel bildirim göstergesini güncelle
                    // Belirli sohbet odası için de bildirim göster
                    const roomNotification = document.getElementById(`private-msg-notification-${chatId}`);
                    if (roomNotification) {
                        roomNotification.style.display = 'flex';
                    }
                }
            };

            // Önceki dinleyiciyi kaldır
            if (activeListeners[`privateMsgNotification-${chatId}`]) {
                messagesRef.off('child_added', activeListeners[`privateMsgNotification-${chatId}`].callback);
            }

            messagesRef.on('child_added', messageCallback);
            activeListeners[`privateMsgNotification-${chatId}`] = { callback: messageCallback };

            // Son görülme zamanı değiştiğinde, mesaj bildirimini sıfırla
            lastSeenRef.on('value', (snapshot) => {
                lastSeenTimestamp = snapshot.val();
                const roomNotification = document.getElementById(`private-msg-notification-${chatId}`);
                if (roomNotification && lastSeenTimestamp) {
                     // Sadece son mesajın timestamp'i lastSeenTimestamp'tan küçük veya eşitse gizle
                     messagesRef.limitToLast(1).once('value', (msgSnapshot) => {
                        if (msgSnapshot.exists()) {
                            const latestMessage = Object.values(msgSnapshot.val())[0];
                            if (latestMessage.senderUid !== currentUserUid && latestMessage.timestamp > lastSeenTimestamp) {
                                roomNotification.style.display = 'flex'; // Hala yeni mesaj varsa göster
                                hasNewPrivateMessages = true;
                            } else {
                                roomNotification.style.display = 'none';
                            }
                        } else {
                            roomNotification.style.display = 'none';
                        }
                        updateFriendRequestNotification(); // Genel bildirimi de kontrol et
                     });
                }
            });
        }


        function updateFriendRequestNotification() {
            if (hasNewFriendRequests || hasNewPrivateMessages) {
                friendRequestNotification.style.display = 'flex';
                friendRequestNotification.textContent = ''; // Sayı göstermiyoruz, sadece uyarı var
            } else {
                friendRequestNotification.style.display = 'none';
            }
        }

        // --- Particle JS Initialization ---
        particlesJS("particles-js", {
            "particles": {
                "number": {
                    "value": 80,
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": {
                    "value": "#00eeff"
                },
                "shape": {
                    "type": "circle",
                    "stroke": {
                        "width": 0,
                        "color": "#000000"
                    },
                    "polygon": {
                        "nb_sides": 5
                    },
                    "image": {
                        "src": "img/github.svg",
                        "width": 100,
                        "height": 100
                    }
                },
                "opacity": {
                    "value": 0.5,
                    "random": false,
                    "anim": {
                        "enable": false,
                        "speed": 1,
                        "opacity_min": 0.1,
                        "sync": false
                    }
                },
                "size": {
                    "value": 3,
                    "random": true,
                    "anim": {
                        "enable": false,
                        "speed": 40,
                        "size_min": 0.1,
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": true,
                    "distance": 150,
                    "color": "#00eeff",
                    "opacity": 0.4,
                    "width": 1
                },
                "move": {
                    "enable": true,
                    "speed": 6,
                    "direction": "none",
                    "random": false,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false,
                    "attract": {
                        "enable": false,
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": true,
                        "mode": "grab"
                    },
                    "onclick": {
                        "enable": true,
                        "mode": "push"
                    },
                    "resize": true
                },
                "modes": {
                    "grab": {
                        "distance": 140,
                        "line_linked": {
                            "opacity": 1
                        }
                    },
                    "bubble": {
                        "distance": 400,
                        "size": 40,
                        "duration": 2,
                        "opacity": 8,
                        "speed": 3
                    },
                    "repulse": {
                        "distance": 200,
                        "duration": 0.4
                    },
                    "push": {
                        "particles_nb": 4
                    },
                    "remove": {
                        "particles_nb": 2
                    }
                }
            },
            "retina_detect": true
        });


    
function showToastMessage() {
    const toast = document.getElementById("message-toast");
    toast.style.display = "block";
    document.getElementById("notification-sound").play();
    toast.onclick = () => {
        showScreen("chat-screen");
        toast.style.display = "none";
    };
    setTimeout(() => {
        toast.style.display = "none";
    }, 5000);
}

// Chat'e gelen mesajlarda tetiklenmeli
// displayMessage gibi fonksiyon içine: showToastMessage();

function encryptText() {
    const plainText = document.getElementById("plain-text").value;
    const encoded = btoa(plainText);
    document.getElementById("encrypted-text").value = encoded;
}
function decryptText() {
    const encryptedText = document.getElementById("encrypted-text").value;
    try {
        const decoded = atob(encryptedText);
        document.getElementById("plain-text").value = decoded;
    } catch (e) {
        alert("Geçersiz şifreli metin!");
    }
}

</script>

<div id="message-toast" style="position: fixed; bottom: 20px; right: 20px; background: var(--notification-bg); color: white; padding: 15px 20px; border-radius: 8px; border: 1px solid var(--notification-border); box-shadow: 0 0 15px var(--notification-border); z-index: 5000; display: none; cursor: pointer; font-family: Orbitron;">
📩 Yeni mesajınız var! Tıklayın.
</div>
<audio id="notification-sound" src="https://www.myinstants.com/media/sounds/notification.mp3" preload="auto"></audio>

</body>
</html>