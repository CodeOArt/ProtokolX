<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site-X</title>
    <link rel="icon" href="https://via.placeholder.com/32/FF00FF/0A0A0A?text=X" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--primary-color:#00EEFF;--secondary-color:#FF00FF;--background-dark:#0a0a0f;--background-light:#10101a;--text-light:#E0E0E0;--text-dark:#111;--error-red:#ff3b30;--success-green:#34c759;--warning-yellow:#ffcc00;--border-glow:rgba(0, 238, 255, 0.4);--shadow-glow:0 0 15px var(--border-glow);--sidebar-width:240px;--sidebar-width-collapsed:70px;}
        *{box-sizing:border-box;margin:0;padding:0;scrollbar-width:thin;scrollbar-color:var(--primary-color) var(--background-dark);}
        ::-webkit-scrollbar{width:8px;}
        ::-webkit-scrollbar-track{background:rgba(0, 0, 0, 0.3);}
        ::-webkit-scrollbar-thumb{background:var(--primary-color);border-radius:4px;}
        ::-webkit-scrollbar-thumb:hover{background:var(--secondary-color);}
        body{font-family:'Share Tech Mono', monospace;background-color:var(--background-dark);color:var(--text-light);display:flex;min-height:100vh;overflow:hidden;background-image:radial-gradient(ellipse at 70% 30%, rgba(0, 238, 255, 0.08) 0%, transparent 40%), radial-gradient(ellipse at 30% 70%, rgba(255, 0, 255, 0.08) 0%, transparent 40%);}
        
        #background-animation{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;overflow:hidden;}
        .hexagon{position:absolute;width:100px;height:110px;background-color:rgba(0, 238, 255, 0.03);clip-path:polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);animation:float 20s infinite linear;}
        @keyframes float{0%{transform:translateY(120vh) rotate(0deg);}100%{transform:translateY(-20vh) rotate(360deg);}}
        
        /* --- Login Screen --- */
        #login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--background-dark);z-index:9999;display:flex;justify-content:center;align-items:center;transition:opacity .5s, visibility .5s;opacity:1;visibility:visible;}
        #login-overlay.hidden{opacity:0;visibility:hidden;}
        #login-container{width:400px;padding:40px;background:rgba(20, 20, 30, 0.8);border:1px solid var(--primary-color);border-radius:10px;box-shadow:0 0 30px var(--border-glow);backdrop-filter:blur(10px);text-align:center;position:relative;}
        #retina-scanner{width:150px;height:150px;border-radius:50%;margin:0 auto 20px;border:2px solid var(--primary-color);position:relative;overflow:hidden;background:radial-gradient(circle, rgba(0,238,255,0.3) 0%, transparent 70%);}
        #retina-scanner .scan-line{position:absolute;top:0;left:0;width:100%;height:3px;background:var(--primary-color);box-shadow:0 0 10px var(--primary-color);animation:scan 3s linear infinite;}
        @keyframes scan{0%{top:0;}50%{top:100%;}100%{top:0;}}
        #login-title{font-family:'Orbitron', sans-serif;font-size:2em;color:var(--primary-color);text-shadow:0 0 10px var(--primary-color);margin-bottom:20px;}
        .login-form-group{margin-bottom:15px;}
        .login-form-group input{width:100%;background:rgba(0,0,0,0.4);border:1px solid var(--primary-color);color:var(--text-light);padding:12px;border-radius:5px;font-family:inherit;outline:none;transition:all .3s;}
        .login-form-group input:focus{box-shadow:0 0 15px var(--border-glow);background:rgba(0,0,0,0.6);}
        .btn-primary{width:100%;padding:12px;background:var(--primary-color);border:none;color:var(--text-dark);font-family:'Orbitron', sans-serif;cursor:pointer;border-radius:5px;transition:all .3s;position:relative;overflow:hidden;}
        .btn-primary:hover{background:var(--secondary-color);color:var(--text-light);box-shadow:0 0 15px var(--secondary-color);}
        #login-status{margin-top:15px;color:var(--error-red);display:none;}
        #switch-auth-link{color:var(--primary-color);text-decoration:none;margin-top:20px;display:inline-block;cursor:pointer;}
        #login-container.error{animation:glitch-effect .4s;}
        @keyframes glitch-effect{0%{transform:translate(0);border-color:var(--error-red);}20%{transform:translate(-3px, 3px);}40%{transform:translate(3px, -3px);}60%{transform:translate(-3px, -3px);}80%{transform:translate(3px, 3px);}100%{transform:translate(0);border-color:var(--error-red);}}

        /* --- Main Layout --- */
        #app-container{display:flex;width:100%;height:100vh;}
        #sidebar{width:var(--sidebar-width);background:var(--background-light);border-right:1px solid var(--primary-color);display:flex;flex-direction:column;transition:width .3s ease;z-index:100;box-shadow:5px 0 25px rgba(0, 238, 255, 0.1);}
        #sidebar.collapsed{width:var(--sidebar-width-collapsed);}
        #sidebar-header{padding:20px;text-align:center;border-bottom:1px solid var(--primary-color);}
        #site-logo{font-family:'Orbitron';font-size:2em;color:var(--primary-color);cursor:pointer;}
        #sidebar.collapsed #site-logo{font-size:1.8em;}
        #sidebar nav{flex-grow:1;padding-top:20px;}
        .nav-item{display:flex;align-items:center;padding:15px 20px;color:var(--text-light);text-decoration:none;transition:all .2s;white-space:nowrap;overflow:hidden;}
        .nav-item i{width:30px;font-size:1.2em;text-align:center;margin-right:15px;}
        .nav-item:hover, .nav-item.active{background:rgba(0, 238, 255, 0.1);color:var(--primary-color);border-right:3px solid var(--primary-color);box-shadow:inset -10px 0 15px -10px rgba(0, 238, 255, 0.2);}
        #sidebar.collapsed .nav-item span{display:none;}
        #sidebar.collapsed .nav-item i{margin-right:0;}
        #sidebar-footer{padding:20px;border-top:1px solid var(--primary-color);}
        #user-profile-widget{display:flex;align-items:center;cursor:pointer;}
        #user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary-color);color:var(--text-dark);display:flex;justify-content:center;align-items:center;font-family:'Orbitron';font-weight:700;margin-right:10px;position:relative;}
        .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--secondary-color);color:white;border-radius:50%;width:18px;height:18px;font-size:0.7em;display:flex;justify-content:center;align-items:center;}
        #user-info .username{font-weight:700;}
        #user-info .rank{font-size:0.8em;color:#aaa;}
        #sidebar.collapsed #user-info{display:none;}
        #sidebar-toggle{background:var(--primary-color);color:var(--text-dark);border:none;width:30px;height:30px;border-radius:50%;position:absolute;left:calc(var(--sidebar-width) - 15px);top:20px;cursor:pointer;z-index:101;transition:left .3s, transform .3s;}
        #sidebar.collapsed #sidebar-toggle{left:calc(var(--sidebar-width-collapsed) - 15px);}
        #sidebar-toggle:hover{transform:scale(1.1);}

        /* --- Main Content Area --- */
        #main-content{flex-grow:1;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
        #page-header{padding:15px 25px;background:var(--background-light);border-bottom:1px solid var(--primary-color);display:flex;justify-content:space-between;align-items:center;}
        #page-title{font-family:'Orbitron';font-size:1.8em;}
        #page-content{flex-grow:1;padding:25px;overflow-y:auto;position:relative;overflow-x:hidden;}
        .page{display:none;height:100%;animation:fadeIn .5s;}
        .page.active{display:block;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
        #dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:20px;}
        .widget{background:var(--background-light);border:1px solid var(--primary-color);padding:20px;border-radius:8px;box-shadow:0 0 15px rgba(0, 238, 255, 0.1);transition:all .3s;}
        .widget:hover{transform:translateY(-5px);box-shadow:0 5px 25px rgba(0, 238, 255, 0.2);}
        .widget h3{font-family:'Orbitron';margin-bottom:15px;color:var(--primary-color);border-bottom:1px solid var(--secondary-color);padding-bottom:10px;}
        .widget-content{font-size:1.2em;}
        
        /* Chat Page */
        #chat-page{display:flex;flex-direction:column;height:100%;}
        #chat-messages{flex-grow:1;padding:15px;background:rgba(0,0,0,0.2);border-radius:8px;overflow-y:auto;margin-bottom:15px;}
        .message{position:relative;padding:10px 15px;border-radius:10px;margin-bottom:10px;max-width:70%;line-height:1.5;}
        .message.sent{background:linear-gradient(90deg, rgba(0, 238, 255, 0.1), rgba(0, 238, 255, 0.2));margin-left:auto;border-left:3px solid var(--primary-color);}
        .message.received{background:linear-gradient(90deg, rgba(255, 0, 255, 0.1), rgba(255, 0, 255, 0.2));margin-right:auto;border-left:3px solid var(--secondary-color);}
        .message-sender{font-weight:700;color:var(--primary-color);margin-bottom:5px;cursor:pointer;}
        .message.received .message-sender{color:var(--secondary-color);}
        .message-text{word-wrap:break-word;}
        .message-timestamp{font-size:0.8em;color:#aaa;text-align:right;margin-top:5px;}
        .message-actions{display:none;position:absolute;right:10px;top:10px;}
        .message:hover .message-actions{display:flex;gap:5px;}
        .message-action-btn{background:rgba(0,0,0,0.5);border:1px solid var(--primary-color);color:var(--primary-color);width:20px;height:20px;border-radius:3px;cursor:pointer;font-size:0.7em;display:flex;align-items:center;justify-content:center;}
        .reply-to-bar{background:rgba(0, 238, 255, 0.1);padding:8px;border-radius:5px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border-left:3px solid var(--primary-color);}
        .reply-to-text{flex-grow:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .cancel-reply-btn{background:none;border:none;color:var(--primary-color);cursor:pointer;}
        
        /* Chat Input */
        #chat-input-container{display:flex;gap:10px;padding:10px;background:var(--background-light);border-top:1px solid var(--primary-color);}
        #chat-input{flex-grow:1;background:rgba(0,0,0,0.3);border:1px solid var(--primary-color);color:var(--text-light);padding:10px;border-radius:5px;font-family:inherit;outline:none;transition:all .3s;}
        #chat-input:focus{box-shadow:0 0 10px var(--border-glow);}
        #send-message-btn{background:var(--primary-color);color:var(--text-dark);border:none;padding:0 20px;border-radius:5px;cursor:pointer;font-family:'Orbitron';transition:all .3s;}
        #send-message-btn:hover{background:var(--secondary-color);color:var(--text-light);}
        
        /* Friends Page */
        .friends-section{margin-bottom:25px;}
        .friends-section h4{color:var(--primary-color);margin-bottom:15px;padding-bottom:5px;border-bottom:1px solid var(--secondary-color);}
        .friends-list{list-style:none;}
        .friend-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:5px;margin-bottom:5px;background:rgba(0,0,0,0.2);transition:all .3s;}
        .friend-item:hover{background:rgba(0, 238, 255, 0.1);}
        .friend-info{display:flex;align-items:center;gap:10px;}
        .friend-status{width:10px;height:10px;border-radius:50%;background:#888;}
        .friend-status.online{background:var(--success-green);box-shadow:0 0 5px var(--success-green);}
        .friend-name{font-weight:700;}
        .friend-rank{padding:2px 5px;border-radius:3px;font-size:0.8em;background:rgba(0, 238, 255, 0.2);}
        .friend-actions{display:flex;gap:5px;}
        .friend-action-btn{padding:5px 10px;border-radius:3px;font-size:0.8em;cursor:pointer;transition:all .3s;}
        .pm-btn{background:var(--primary-color);color:var(--text-dark);}
        .remove-btn{background:var(--error-red);color:white;}
        
        /* Data Panel */
        .data-panel-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;}
        .data-widget{background:var(--background-light);border:1px solid var(--primary-color);border-radius:8px;padding:15px;box-shadow:0 0 15px rgba(0, 238, 255, 0.1);}
        .data-widget h4{color:var(--primary-color);margin-bottom:15px;}
        #data-chart{width:100%;height:200px;}
        #quantum-matrix{display:grid;grid-template-columns:repeat(12, 1fr);gap:5px;margin-top:15px;}
        .matrix-cell{aspect-ratio:1/1;background:rgba(0, 238, 255, 0.1);border-radius:2px;transition:all .2s;}
        .matrix-cell.active{background:var(--primary-color);box-shadow:0 0 5px var(--primary-color);}
        #core-temp-gauge{height:20px;background:rgba(0,0,0,0.3);border-radius:10px;margin-top:10px;overflow:hidden;}
        #core-temp-bar{height:100%;background:var(--success-green);width:0%;transition:width .5s, background .5s;}
        
        /* Admin Panel */
        .admin-section{margin-bottom:25px;}
        .admin-section h4{color:var(--primary-color);margin-bottom:15px;padding-bottom:5px;border-bottom:1px solid var(--secondary-color);}
        .user-list{list-style:none;}
        .user-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:5px;margin-bottom:5px;background:rgba(0,0,0,0.2);}
        .user-info{flex-grow:1;}
        .user-name{font-weight:700;}
        .user-rank{padding:2px 5px;border-radius:3px;font-size:0.8em;background:rgba(0, 238, 255, 0.2);}
        .user-specialty{padding:2px 5px;border-radius:3px;font-size:0.8em;background:rgba(255, 0, 255, 0.2);}
        .user-warnings{color:var(--error-red);font-size:0.8em;}
        .user-actions{display:flex;gap:5px;}
        .user-action-btn{padding:5px 10px;border-radius:3px;font-size:0.8em;cursor:pointer;transition:all .3s;}
        .promote-btn{background:var(--success-green);color:var(--text-dark);}
        .warn-btn{background:var(--warning-yellow);color:var(--text-dark);}
        .ban-btn{background:var(--error-red);color:white;}
        #announcement-textarea{width:100%;height:150px;background:rgba(0,0,0,0.3);border:1px solid var(--primary-color);color:var(--text-light);padding:10px;border-radius:5px;margin-bottom:10px;resize:vertical;font-family:inherit;}
        
        /* Global Command Line */
        #global-command-line{padding:10px 25px;background:var(--background-light);border-top:1px solid var(--primary-color);display:flex;align-items:center;}
        #global-command-line .prompt{font-family:'Orbitron';color:var(--primary-color);margin-right:10px;}
        #command-input{flex-grow:1;background:0;border:0;color:var(--text-light);font-family:inherit;font-size:1em;outline:0;}
        
        /* Toast Notifications */
        #toast-container{position:fixed;top:20px;right:20px;z-index:9999;}
        .toast{background:linear-gradient(135deg, var(--background-light), #1a1a2a);border:1px solid var(--primary-color);border-radius:8px;padding:15px;margin-bottom:10px;box-shadow:0 5px 15px rgba(0,0,0,0.3);display:flex;align-items:center;transform:translateX(120%);animation:slideIn .5s forwards;}
        .toast.error{border-color:var(--error-red);}
        .toast.success{border-color:var(--success-green);}
        .toast.warning{border-color:var(--warning-yellow);}
        @keyframes slideIn{to{transform:translateX(0);}}
        @keyframes slideOut{to{transform:translateX(120%);}}
        
        /* Modals */
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9998;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:all .3s;backdrop-filter:blur(5px);}
        .modal-overlay.active{opacity:1;visibility:visible;}
        .modal{background:var(--background-light);border:1px solid var(--primary-color);border-radius:10px;width:90%;max-width:500px;padding:25px;box-shadow:0 0 30px rgba(0, 238, 255, 0.2);position:relative;transform:translateY(20px);transition:all .3s;}
        .modal-overlay.active .modal{transform:translateY(0);}
        .modal-close{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--primary-color);font-size:1.5em;cursor:pointer;}
        .modal-title{font-family:'Orbitron';color:var(--primary-color);margin-bottom:20px;text-align:center;}
        
        /* Private Chat Modal */
        #private-chat-modal .modal{width:90%;max-width:600px;height:80vh;display:flex;flex-direction:column;}
        #private-chat-messages{flex-grow:1;overflow-y:auto;margin-bottom:15px;background:rgba(0,0,0,0.2);border-radius:5px;padding:10px;}
        #private-chat-input-container{display:flex;gap:10px;margin-top:15px;}
        #private-chat-input{flex-grow:1;background:rgba(0,0,0,0.3);border:1px solid var(--primary-color);color:var(--text-light);padding:10px;border-radius:5px;font-family:inherit;outline:none;}
        
        /* Data Panel Login Modal */
        #data-panel-login-modal .modal{max-width:400px;}
        #access-denied-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;color:var(--error-red);font-family:'Orbitron';font-size:1.5em;text-shadow:0 0 10px var(--error-red);z-index:10;opacity:0;pointer-events:none;transition:opacity .3s;}
        #access-denied-overlay.active{opacity:1;pointer-events:all;animation:pulseText .5s infinite alternate;}
        @keyframes pulseText{0%{opacity:0.8;}100%{opacity:1;}}
        #data-panel-login-modal.error{animation:glitch-effect .5s;}

        /* Profile Modal */
        #profile-modal .modal{width:90%;max-width:400px;}
        .profile-header{display:flex;align-items:center;margin-bottom:20px;}
        .profile-avatar{width:80px;height:80px;border-radius:50%;background:var(--primary-color);color:var(--text-dark);display:flex;justify-content:center;align-items:center;font-family:'Orbitron';font-size:2em;font-weight:700;margin-right:20px;}
        .profile-info{flex-grow:1;}
        .profile-name{font-family:'Orbitron';font-size:1.5em;margin-bottom:5px;}
        .profile-rank{padding:5px 10px;border-radius:5px;background:rgba(0, 238, 255, 0.2);display:inline-block;}
        .profile-warnings{color:var(--error-red);margin-top:5px;font-size:0.9em;}
        .profile-details{margin-top:20px;}
        .profile-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(0, 238, 255, 0.2);}
        .profile-row:last-child{border-bottom:none;}
        .profile-label{color:var(--primary-color);}
        .profile-value{text-align:right;}
        .profile-actions{margin-top:20px;display:flex;gap:10px;}
        .profile-action-btn{flex-grow:1;padding:10px;border-radius:5px;font-family:'Orbitron';cursor:pointer;transition:all .3s;}
        .pm-btn{background:var(--primary-color);color:var(--text-dark);border:none;}
        .add-friend-btn{background:var(--success-green);color:var(--text-dark);border:none;}
        .block-btn{background:var(--error-red);color:white;border:none;}
        
        /* Settings Modal */
        #settings-modal .modal{width:90%;max-width:500px;}
        .settings-section{margin-bottom:20px;}
        .settings-section h4{color:var(--primary-color);margin-bottom:15px;padding-bottom:5px;border-bottom:1px solid var(--secondary-color);}
        .setting-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(0, 238, 255, 0.1);}
        .setting-label{flex-grow:1;}
        .toggle-switch{position:relative;display:inline-block;width:50px;height:24px;}
        .toggle-switch input{opacity:0;width:0;height:0;}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.3);transition:.4s;border-radius:24px;border:1px solid var(--primary-color);}
        .toggle-slider:before{position:absolute;content:"";height:16px;width:16px;left:4px;bottom:3px;background-color:var(--primary-color);transition:.4s;border-radius:50%;}
        input:checked + .toggle-slider{background-color:rgba(0, 238, 255, 0.2);}
        input:checked + .toggle-slider:before{transform:translateX(26px);}
        
        /* Username Change */
        .username-change-form{display:flex;gap:10px;margin-top:20px;}
        #new-username-input{flex-grow:1;background:rgba(0,0,0,0.3);border:1px solid var(--primary-color);color:var(--text-light);padding:10px;border-radius:5px;font-family:inherit;outline:none;}
        #change-username-btn{padding:10px 15px;background:var(--primary-color);color:var(--text-dark);border:none;border-radius:5px;font-family:'Orbitron';cursor:pointer;}
    </style>
</head>
<body>

<div id="background-animation"></div>

<div id="login-overlay">
    <div id="login-container">
        <div id="retina-scanner"><div class="scan-line"></div></div>
        <h1 id="login-title">Site-X Erişimi</h1>
        <div class="login-form-group">
            <input type="email" id="email-input" placeholder="Operatör ID (E-posta)" required>
        </div>
        <div class="login-form-group">
            <input type="password" id="password-input" placeholder="Parola" required>
        </div>
        <button class="btn-primary" id="auth-btn">BAĞLANTI KUR</button>
        <div id="login-status">Hatalı Kimlik Bilgileri</div>
        <a id="switch-auth-link">Yeni Operatör Kaydı</a>
    </div>
</div>

<div id="app-container" style="display: none;">
    <aside id="sidebar">
        <div id="sidebar-header">
            <span id="site-logo">S-X</span>
        </div>
        <nav>
            <a href="#" class="nav-item active" data-page="dashboard-page"><i>⚏</i> <span>Ana Panel</span></a>
            <a href="#" class="nav-item" data-page="chat-page"><i></i> <span>İletişim</span></a>
            <a href="#" class="nav-item" data-page="friends-page"><i></i> <span>Bağlantılar</span></a>
            <a href="#" class="nav-item" data-page="data-panel-page"><i></i> <span>Veri Paneli</span></a>
            <a href="#" class="nav-item" data-page="admin-page" id="admin-nav-item" style="display:none;"><i></i> <span>Yönetim</span></a>
        </nav>
        <div id="sidebar-footer">
            <div id="user-profile-widget">
                <div id="user-avatar">?</div>
                <div id="user-info">
                    <div class="username" id="sidebar-username">Operatör</div>
                    <div class="rank" id="sidebar-rank">Rütbe: N/A</div>
                </div>
            </div>
        </div>
        <button id="sidebar-toggle"><</button>
    </aside>

    <main id="main-content">
        <header id="page-header">
            <h2 id="page-title">Ana Panel</h2>
            <div id="header-actions">
                <button class="btn-primary" id="logout-btn" style="padding: 8px 15px;">ÇIKIŞ</button>
            </div>
        </header>

        <div id="page-content">
          
            <div id="dashboard-page" class="page active">
                <h3>Sistem Durumu</h3>
                <div id="dashboard-grid">
                    <div class="widget"><h3>Çevrimiçi Operatörler</h3><div class="widget-content" id="online-users-widget">0</div></div>
                    <div class="widget"><h3>Bekleyen İstekler</h3><div class="widget-content" id="pending-requests-widget">0</div></div>
                    <div class="widget"><h3>Sistem Mesajı</h3><div class="widget-content" id="system-message-widget">Tüm sistemler normal.</div></div>
                </div>
                <div class="widget" style="grid-column:1/-1;margin-top:20px;">
                    <h3>Son Duyuru</h3>
                    <div class="widget-content" id="latest-announcement-widget">Duyuru yok</div>
                </div>
            </div>

            <div id="chat-page" class="page">
                <div id="chat-messages"></div>
                <div id="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Mesajınızı yazın...">
                    <button id="send-message-btn">Gönder</button>
                </div>
            </div>
            
            <div id="friends-page" class="page">
                <div class="friends-section">
                    <h4>Bağlantılar</h4>
                    <ul class="friends-list" id="friends-list"></ul>
                </div>
                <div class="friends-section">
                    <h4>Bekleyen İstekler</h4>
                    <ul class="friends-list" id="friend-requests-list"></ul>
                </div>
            </div>
            
            <div id="data-panel-page" class="page">
                <h3>Site-x Veri Paneli</h3>
                <div class="data-panel-grid">
                    <div class="data-widget">
                        <h4>Sinyal Analizi</h4>
                        <canvas id="data-chart"></canvas>
                    </div>
                    <div class="data-widget">
                        <h4>Kuantum Matrisi</h4>
                        <div id="quantum-matrix"></div>
                    </div>
                    <div class="data-widget">
                        <h4>Çekirdek Sıcaklığı</h4>
                        <div id="core-temp-value">--.- °C</div>
                        <div id="core-temp-gauge"><div id="core-temp-bar"></div></div>
                    </div>
                </div>
            </div>

            <div id="admin-page" class="page">
                <div class="admin-section">
                    <h4>Kullanıcı Yönetimi</h4>
                    <ul class="user-list" id="user-management-list"></ul>
                </div>
                <div class="admin-section">
                    <h4>Sistem Duyurusu</h4>
                    <textarea id="announcement-textarea" placeholder="Duyuru metnini buraya yazın..."></textarea>
                    <button class="btn-primary" id="publish-announcement-btn">Duyuruyu Yayınla</button>
                </div>
            </div>
        </div>
        
        <div id="global-command-line">
            <span class="prompt">></span>
            <input type="text" id="command-input" placeholder="Komut girin... (/help için yardım)">
        </div>
    </main>
</div>

<!-- Modals -->
<div id="private-chat-modal" class="modal-overlay">
    <div class="modal">
        <button class="modal-close" id="private-chat-close">×</button>
        <h3 class="modal-title" id="private-chat-title">Özel Sohbet</h3>
        <div id="private-chat-messages"></div>
        <div id="private-chat-input-container">
            <input type="text" id="private-chat-input" placeholder="Mesajınızı yazın...">
            <button id="send-private-message-btn">Gönder</button>
        </div>
    </div>
</div>

<div id="data-panel-login-modal" class="modal-overlay">
    <div class="modal">
        <button class="modal-close" id="data-panel-login-close">×</button>
        <h3 class="modal-title">Veri Paneli Erişimi</h3>
        <div id="access-denied-overlay">ERİŞİM REDDEDİLDİ</div>
        <div class="login-form-group">
            <input type="password" id="access-code-input" placeholder="Erişim Kodunu Girin">
        </div>
        <button class="btn-primary" id="data-panel-login-btn">GİRİŞ YAP</button>
        <div id="data-panel-login-status" style="display:none;color:var(--error-red);margin-top:15px;"></div>
    </div>
</div>

<div id="profile-modal" class="modal-overlay">
    <div class="modal">
        <button class="modal-close" id="profile-close">×</button>
        <h3 class="modal-title">Operatör Profili</h3>
        <div class="profile-header">
            <div class="profile-avatar" id="profile-avatar">?</div>
            <div class="profile-info">
                <div class="profile-name" id="profile-name">Operatör</div>
                <div class="profile-rank" id="profile-rank">X-0</div>
                <div class="profile-warnings" id="profile-warnings"></div>
            </div>
        </div>
        <div class="profile-details">
            <div class="profile-row">
                <span class="profile-label">Durum:</span>
                <span class="profile-value" id="profile-status">Çevrimdışı</span>
            </div>
            <div class="profile-row">
                <span class="profile-label">Uzmanlık:</span>
                <span class="profile-value" id="profile-specialty">Yeni Bağlantı</span>
            </div>
            <div class="profile-row">
                <span class="profile-label">Son Görülme:</span>
                <span class="profile-value" id="profile-last-seen">Bilinmiyor</span>
            </div>
        </div>
        <div class="profile-actions">
            <button class="profile-action-btn pm-btn" id="profile-pm-btn">Mesaj Gönder</button>
            <button class="profile-action-btn add-friend-btn" id="profile-add-friend-btn">Bağlantı Ekle</button>
            <button class="profile-action-btn block-btn" id="profile-block-btn">Engelle</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal">
        <button class="modal-close" id="settings-close">×</button>
        <h3 class="modal-title">Ayarlar</h3>
        <div class="settings-section">
            <h4>Kullanıcı Adı</h4>
            <div class="username-change-form">
                <input type="text" id="new-username-input" placeholder="Yeni kullanıcı adı">
                <button id="change-username-btn">Değiştir</button>
            </div>
        </div>
        <div class="settings-section">
            <h4>Bildirimler</h4>
            <div class="setting-item">
                <span class="setting-label">Sesli Bildirim</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="sound-notifications-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span class="setting-label">Metin Okuma (TTS)</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="tts-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        <div class="settings-section">
            <h4>Görünüm</h4>
            <div class="setting-item">
                <span class="setting-label">Koyu Tema</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="dark-mode-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDfOV4i2BNdBw-JaTdyVTMYGVlJbn4wokI",
        authDomain: "xprotokol-1c921.firebaseapp.com",
        projectId: "xprotokol-1c921",
        storageBucket: "xprotokol-1c921.appspot.com",
        messagingSenderId: "807546069984",
        appId: "1:807546069984:web:2be71812e56c331af34185"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // --- GLOBAL STATE & CONSTANTS ---
    const ACCESS_CODE = '18811938';
    const rpIntervals = {};
    let dataPanelLoginAttempts = 0;
    let dataPanelLockoutUntil = 0;
    let currentUserRank = "X-0";
    let currentUserName = "Misafir";
    let currentUserId = null;
    let isLoginMode = true;
    let repliedMessageId = null;
    let repliedMessageText = null;
    let currentPrivateChatUserId = null;
    let currentProfileUserId = null;
    let unreadMessages = {};
    let soundEnabled = true;
    let ttsEnabled = true;
    let speechSynthesis = window.speechSynthesis;

    // --- UTILITY FUNCTIONS ---
    function createToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        
        // Play sound for notification
        if (soundEnabled && type !== 'info') {
            const audio = new Audio(type === 'error' ? 
                'https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3' : 
                'https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3');
            audio.volume = 0.3;
            audio.play();
        }
        
        // Text-to-speech if enabled
        if (ttsEnabled && speechSynthesis) {
            const utterance = new SpeechSynthesisUtterance(message);
            utterance.lang = 'tr-TR';
            speechSynthesis.speak(utterance);
        }
        
        setTimeout(() => { 
            toast.style.animation = 'slideOut .5s forwards'; 
            setTimeout(() => toast.remove(), 500); 
        }, 4000);
    }
    
    function showAlert(message, type = 'info') {
        createToast(message, type);
    }

    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('tr-TR');
    }

    // --- SCREEN & PAGE MANAGEMENT ---
    function showPage(pageId) {
        // Clear any running intervals
        Object.values(rpIntervals).forEach(clearInterval);
        if (rpIntervals.chartInstance) { 
            rpIntervals.chartInstance.destroy(); 
            delete rpIntervals.chartInstance; 
        }
        
        // Hide all pages and show the selected one
        document.querySelectorAll('.page').forEach(p => {
            p.classList.remove('active');
            p.style.display = 'none';
        });
        const activePage = document.getElementById(pageId);
        activePage.classList.add('active');
        activePage.style.display = 'block';

        // Update active nav item
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.page === pageId);
        });
        
        // Update page title
        const title = document.querySelector(`.nav-item[data-page="${pageId}"] span`).textContent;
        document.getElementById('page-title').textContent = title;

        // Load content for the specific page
        switch(pageId) {
            case 'chat-page':
                loadChatMessages();
                break;
            case 'friends-page':
                loadFriendsAndRequests();
                break;
            case 'data-panel-page':
                initDataPanel();
                break;
            case 'admin-page':
                if(currentUserRank === "X-5") {
                    loadUserManagement();
                    loadLatestAnnouncement();
                }
                break;
        }
    }

    // --- AUTHENTICATION & USER MANAGEMENT ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUserId = user.uid;
            await updateUserProfile(user);
            document.getElementById('app-container').style.display = 'flex';
            document.getElementById('login-overlay').classList.add('hidden');
            showPage('dashboard-page');
            setupRealtimeListeners();
            showAlert(`Hoş geldiniz, ${currentUserName}`, 'success');
            
            // Load latest announcement
            loadLatestAnnouncementForDashboard();
        } else {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-overlay').classList.remove('hidden');
            currentUserRank = "X-0";
            currentUserName = "Misafir";
            currentUserId = null;
        }
    });

    async function updateUserProfile(user) {
        const userRef = database.ref('users/' + user.uid);
        const snapshot = await userRef.once('value'); 
        let userData = snapshot.val();
        
        if (!userData) { 
            userData = { 
                email: user.email, 
                username: user.email.split('@')[0], 
                specialty: "Personel", 
                rank: "X-0",
                online: true,
                lastSeen: Date.now()
            }; 
            await userRef.set(userData); 
        }
        
        currentUserName = userData.username || userData.email.split('@')[0];
        currentUserRank = userData.rank || 'X-0';
        
        // Update sidebar user info
        document.getElementById('sidebar-username').textContent = currentUserName;
        document.getElementById('sidebar-rank').textContent = `Rütbe: ${currentUserRank}`;
        document.getElementById('user-avatar').textContent = currentUserName.charAt(0).toUpperCase();
        
        // Show/hide admin nav item based on rank
        document.getElementById('admin-nav-item').style.display = (currentUserRank === "X-5") ? 'flex' : 'none';
        
        // Update user online status
        await database.ref(`users/${user.uid}`).update({ 
            online: true,
            lastSeen: Date.now()
        });
        
        // Set up disconnect handler
        database.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === false) {
                database.ref(`users/${user.uid}`).update({ 
                    online: false,
                    lastSeen: Date.now()
                });
            }
        });
    }

    async function changeUsername(newUsername) {
        if (!currentUserId || !newUsername || newUsername.length < 3) {
            showAlert('Kullanıcı adı en az 3 karakter olmalıdır', 'error');
            return;
        }
        
        try {
            await database.ref(`users/${currentUserId}/username`).set(newUsername);
            currentUserName = newUsername;
            document.getElementById('sidebar-username').textContent = currentUserName;
            document.getElementById('user-avatar').textContent = currentUserName.charAt(0).toUpperCase();
            showAlert('Kullanıcı adı başarıyla değiştirildi', 'success');
            document.getElementById('new-username-input').value = '';
        } catch (error) {
            showAlert('Kullanıcı adı değiştirilemedi: ' + error.message, 'error');
        }
    }

    // --- REALTIME LISTENERS ---
    function setupRealtimeListeners() {
        // Online users count
        database.ref('users').orderByChild('online').equalTo(true).on('value', (snapshot) => {
            const count = snapshot.numChildren();
            document.getElementById('online-users-widget').textContent = count;
        });

        // Friend requests
        database.ref(`friendRequests/${currentUserId}`).on('value', (snapshot) => {
            const count = snapshot.numChildren();
            document.getElementById('pending-requests-widget').textContent = count;
            
            // Update notification badge
            updateNotificationBadge();
        });

        // Chat messages
        database.ref('messages').limitToLast(100).on('child_added', (snapshot) => {
            displayMessage(snapshot.val(), snapshot.key);
        });

        // Private messages listener
        database.ref('users').once('value').then((snapshot) => {
            snapshot.forEach((userSnapshot) => {
                const userId = userSnapshot.key;
                if (userId !== currentUserId) {
                    // Create a unique conversation ID by sorting user IDs
                    const conversationId = [currentUserId, userId].sort().join('_');
                    
                    database.ref(`privateMessages/${conversationId}`).limitToLast(1).on('child_added', (messageSnapshot) => {
                        const message = messageSnapshot.val();
                        if (message.senderId !== currentUserId) {
                            // Only count if not in private chat with this user
                            if (currentPrivateChatUserId !== userId) {
                                if (!unreadMessages[userId]) {
                                    unreadMessages[userId] = 0;
                                }
                                unreadMessages[userId]++;
                                updateNotificationBadge();
                                
                                // Show notification
                                showAlert(`Yeni özel mesaj: ${message.senderName}`, 'success');
                            }
                        }
                    });
                }
            });
        });

        // Announcements listener
        database.ref('announcements/latest').on('value', (snapshot) => {
            if (snapshot.exists()) {
                const announcement = snapshot.val();
                document.getElementById('latest-announcement-widget').textContent = announcement.content;
                
                // Show notification if new announcement
                if (announcement.timestamp > Date.now() - 60000) { // Within last minute
                    showAlert('Yeni sistem duyurusu yayınlandı!', 'warning');
                }
            }
        });

        // Warnings listener
        database.ref(`users/${currentUserId}/warnings`).limitToLast(1).on('child_added', (snapshot) => {
            const warning = snapshot.val();
            showAlert(`UYARI: ${warning.reason}`, 'error');
        });
    }

    function updateNotificationBadge() {
        const badge = document.querySelector('#user-avatar .notification-badge');
        const totalUnread = Object.values(unreadMessages).reduce((sum, count) => sum + count, 0);
        
        if (totalUnread > 0) {
            if (!badge) {
                const newBadge = document.createElement('div');
                newBadge.className = 'notification-badge';
                newBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
                document.getElementById('user-avatar').appendChild(newBadge);
            } else {
                badge.textContent = totalUnread > 9 ? '9+' : totalUnread;
            }
        } else if (badge) {
            badge.remove();
        }
    }

    // --- CHAT FUNCTIONALITY ---
    function displayMessage(message, messageId) {
        const chatMessages = document.getElementById('chat-messages');
        const isCurrentUser = message.uid === currentUserId;
        
        const messageEl = document.createElement('div');
        messageEl.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
        
        let html = '';
        if (message.replyToText) {
            html += `<div class="reply-indicator">↩ ${message.replyToText}</div>`;
        }
        
        html += `
            <div class="message-sender" data-user-id="${message.uid}">${message.name} <span class="friend-rank">${message.rank}</span></div>
            <div class="message-text">${message.text}</div>
            <div class="message-timestamp">${formatTimestamp(message.timestamp)}</div>
            <div class="message-actions">
                <button class="message-action-btn" data-action="reply" data-message-id="${messageId}" data-message-text="${message.text}">↩</button>
                ${!isCurrentUser ? `<button class="message-action-btn" data-action="pm" data-user-id="${message.uid}" data-user-name="${message.name}">✉</button>` : ''}
                ${(isCurrentUser || currentUserRank === "X-5") ? `<button class="message-action-btn" data-action="delete" data-message-id="${messageId}">×</button>` : ''}
            </div>
        `;
        
        messageEl.innerHTML = html;
        chatMessages.appendChild(messageEl);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage() {
        const messageInput = document.getElementById('chat-input');
        const text = messageInput.value.trim();
        
        if (!text || !currentUserId) return;
        
        const userRef = database.ref(`users/${currentUserId}`);
        const snapshot = await userRef.once('value');
        const userData = snapshot.val();
        
        const messageData = {
            uid: currentUserId,
            name: userData.username,
            rank: userData.rank,
            text: text,
            timestamp: Date.now(),
            replyTo: repliedMessageId,
            replyToText: repliedMessageText
        };
        
        await database.ref('messages').push(messageData);
        
        // Clear input and reply state
        messageInput.value = '';
        if (repliedMessageId) {
            repliedMessageId = null;
            repliedMessageText = null;
            const replyBar = document.getElementById('reply-to-bar');
            if (replyBar) replyBar.remove();
        }
    }

    async function deleteMessage(messageId) {
        if (!messageId) return;
        
        if (currentUserRank === "X-5" || confirm('Mesajı silmek istediğinize emin misiniz?')) {
            await database.ref('messages/' + messageId).remove();
            showAlert('Mesaj silindi', 'success');
        }
    }

    function loadChatMessages() {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = '';
        database.ref('messages').limitToLast(100).once('value', (snapshot) => {
            snapshot.forEach((childSnapshot) => {
                displayMessage(childSnapshot.val(), childSnapshot.key);
            });
        });
    }

    // --- FRIENDS & PRIVATE MESSAGES ---
    async function loadFriendsAndRequests() {
        // Load friends list
        const friendsList = document.getElementById('friends-list');
        friendsList.innerHTML = '';
        
        const friendsRef = database.ref(`friends/${currentUserId}`);
        friendsRef.on('value', (snapshot) => {
            friendsList.innerHTML = '';
            snapshot.forEach((friendSnapshot) => {
                const friendId = friendSnapshot.key;
                database.ref(`users/${friendId}`).once('value').then((userSnapshot) => {
                    const userData = userSnapshot.val();
                    if (userData) {
                        addFriendToList(friendsList, friendId, userData);
                    }
                });
            });
        });

        // Load friend requests
        const requestsList = document.getElementById('friend-requests-list');
        requestsList.innerHTML = '';
        
        const requestsRef = database.ref(`friendRequests/${currentUserId}`);
        requestsRef.on('value', (snapshot) => {
            requestsList.innerHTML = '';
            snapshot.forEach((requestSnapshot) => {
                const requesterId = requestSnapshot.key;
                database.ref(`users/${requesterId}`).once('value').then((userSnapshot) => {
                    const userData = userSnapshot.val();
                    if (userData) {
                        addFriendRequestToList(requestsList, requesterId, userData);
                    }
                });
            });
        });
    }

    function addFriendToList(listElement, friendId, friendData) {
        const friendItem = document.createElement('li');
        friendItem.className = 'friend-item';
        
        // Check if user has 3 or more warnings
        const warningCount = friendData.warnings ? Object.keys(friendData.warnings).length : 0;
        const isHighWarning = warningCount >= 3;
        
        friendItem.innerHTML = `
            <div class="friend-info">
                <div class="friend-status ${friendData.online ? 'online' : ''}"></div>
                <div class="friend-name" data-user-id="${friendId}" style="${isHighWarning ? 'color: var(--error-red)' : ''}">${friendData.username}</div>
                <div class="friend-rank">${friendData.rank}</div>
                ${warningCount > 0 ? `<div class="user-warnings">${warningCount} uyarı</div>` : ''}
            </div>
            <div class="friend-actions">
                <button class="friend-action-btn pm-btn" data-user-id="${friendId}" data-user-name="${friendData.username}">Mesaj</button>
                <button class="friend-action-btn remove-btn" data-user-id="${friendId}">Sil</button>
            </div>
        `;
        listElement.appendChild(friendItem);
    }

    function addFriendRequestToList(listElement, requesterId, requesterData) {
        const requestItem = document.createElement('li');
        requestItem.className = 'friend-item';
        
        // Check if user has 3 or more warnings
        const warningCount = requesterData.warnings ? Object.keys(requesterData.warnings).length : 0;
        const isHighWarning = warningCount >= 3;
        
        requestItem.innerHTML = `
            <div class="friend-info">
                <div class="friend-status ${requesterData.online ? 'online' : ''}"></div>
                <div class="friend-name" data-user-id="${requesterId}" style="${isHighWarning ? 'color: var(--error-red)' : ''}">${requesterData.username}</div>
                <div class="friend-rank">${requesterData.rank}</div>
                ${warningCount > 0 ? `<div class="user-warnings">${warningCount} uyarı</div>` : ''}
            </div>
            <div class="friend-actions">
                <button class="friend-action-btn pm-btn accept-btn" data-user-id="${requesterId}">Kabul</button>
                <button class="friend-action-btn remove-btn reject-btn" data-user-id="${requesterId}">Red</button>
            </div>
        `;
        listElement.appendChild(requestItem);
    }

    async function sendFriendRequest(targetUserId) {
        if (!currentUserId || !targetUserId) return;
        
        await database.ref(`friendRequests/${targetUserId}/${currentUserId}`).set(true);
        showAlert('Arkadaşlık isteği gönderildi', 'success');
    }

    async function acceptFriendRequest(requesterId) {
        if (!currentUserId || !requesterId) return;
        
        // Add to friends list for both users
        await database.ref(`friends/${currentUserId}/${requesterId}`).set(true);
        await database.ref(`friends/${requesterId}/${currentUserId}`).set(true);
        
        // Remove the request
        await database.ref(`friendRequests/${currentUserId}/${requesterId}`).remove();
        
        showAlert('Arkadaşlık isteği kabul edildi', 'success');
    }

    async function rejectFriendRequest(requesterId) {
        if (!currentUserId || !requesterId) return;
        
        await database.ref(`friendRequests/${currentUserId}/${requesterId}`).remove();
        showAlert('Arkadaşlık isteği reddedildi', 'warning');
    }

    async function removeFriend(friendId) {
        if (!currentUserId || !friendId) return;
        
        // Remove from friends list for both users
        await database.ref(`friends/${currentUserId}/${friendId}`).remove();
        await database.ref(`friends/${friendId}/${currentUserId}`).remove();
        
        showAlert('Arkadaşlık bağlantısı kaldırıldı', 'warning');
    }

    // --- PRIVATE MESSAGING ---
    function openPrivateChat(userId, userName) {
        currentPrivateChatUserId = userId;
        document.getElementById('private-chat-title').textContent = `Özel Sohbet: ${userName}`;
        document.getElementById('private-chat-modal').classList.add('active');
        
        // Load previous messages
        loadPrivateMessages(userId);
        
        // Clear unread count for this user
        if (unreadMessages[userId]) {
            delete unreadMessages[userId];
            updateNotificationBadge();
        }
    }

    function loadPrivateMessages(targetUserId) {
        const privateChatMessages = document.getElementById('private-chat-messages');
        privateChatMessages.innerHTML = '';
        
        if (!currentUserId || !targetUserId) return;
        
        // Create a unique conversation ID by sorting user IDs
        const conversationId = [currentUserId, targetUserId].sort().join('_');
        
        database.ref(`privateMessages/${conversationId}`).limitToLast(50).on('value', (snapshot) => {
            privateChatMessages.innerHTML = '';
            snapshot.forEach((childSnapshot) => {
                const message = childSnapshot.val();
                displayPrivateMessage(message);
            });
            privateChatMessages.scrollTop = privateChatMessages.scrollHeight;
        });
    }

    function displayPrivateMessage(message) {
        const privateChatMessages = document.getElementById('private-chat-messages');
        const isCurrentUser = message.senderId === currentUserId;
        
        const messageEl = document.createElement('div');
        messageEl.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
        
        messageEl.innerHTML = `
            <div class="message-sender">${isCurrentUser ? 'Sen' : message.senderName}</div>
            <div class="message-text">${message.text}</div>
            <div class="message-timestamp">${formatTimestamp(message.timestamp)}</div>
        `;
        
        privateChatMessages.appendChild(messageEl);
        privateChatMessages.scrollTop = privateChatMessages.scrollHeight;
    }

    async function sendPrivateMessage() {
        const input = document.getElementById('private-chat-input');
        const text = input.value.trim();
        
        if (!text || !currentUserId || !currentPrivateChatUserId) return;
        
        // Create a unique conversation ID by sorting user IDs
        const conversationId = [currentUserId, currentPrivateChatUserId].sort().join('_');
        
        // Get sender info
        const userSnapshot = await database.ref(`users/${currentUserId}`).once('value');
        const userData = userSnapshot.val();
        
        const messageData = {
            senderId: currentUserId,
            senderName: userData.username,
            receiverId: currentPrivateChatUserId,
            text: text,
            timestamp: Date.now()
        };
        
        await database.ref(`privateMessages/${conversationId}`).push(messageData);
        
        // Clear input
        input.value = '';
    }

    // --- PROFILE VIEW ---
    async function showProfile(userId) {
        currentProfileUserId = userId;
        const userSnapshot = await database.ref(`users/${userId}`).once('value');
        const userData = userSnapshot.val();
        
        if (!userData) return;
        
        document.getElementById('profile-avatar').textContent = userData.username.charAt(0).toUpperCase();
        document.getElementById('profile-name').textContent = userData.username;
        document.getElementById('profile-rank').textContent = userData.rank;
        document.getElementById('profile-status').textContent = userData.online ? 'Çevrimiçi' : 'Çevrimdışı';
        document.getElementById('profile-status').style.color = userData.online ? 'var(--success-green)' : 'var(--error-red)';
        document.getElementById('profile-specialty').textContent = userData.specialty || 'Belirtilmemiş';
        document.getElementById('profile-last-seen').textContent = userData.lastSeen ? formatDate(userData.lastSeen) : 'Bilinmiyor';
        
        // Show warnings count
        const warningsCount = userData.warnings ? Object.keys(userData.warnings).length : 0;
        const warningsElement = document.getElementById('profile-warnings');
        if (warningsCount > 0) {
            warningsElement.textContent = `${warningsCount} uyarı`;
            warningsElement.style.display = 'block';
        } else {
            warningsElement.style.display = 'none';
        }
        
        // Check if already friends
        const isFriend = await database.ref(`friends/${currentUserId}/${userId}`).once('value').then(snap => snap.exists());
        
        const addFriendBtn = document.getElementById('profile-add-friend-btn');
        if (isFriend) {
            addFriendBtn.textContent = 'Bağlantıyı Kaldır';
            addFriendBtn.style.backgroundColor = 'var(--error-red)';
        } else {
            addFriendBtn.textContent = 'Bağlantı Ekle';
            addFriendBtn.style.backgroundColor = 'var(--success-green)';
        }
        
        // Disable block button if user has 3 or more warnings
        const blockBtn = document.getElementById('profile-block-btn');
        if (warningsCount >= 3) {
            blockBtn.disabled = true;
            blockBtn.textContent = 'Engelle (3+ uyarı)';
            blockBtn.style.backgroundColor = 'var(--warning-yellow)';
        } else {
            blockBtn.disabled = false;
            blockBtn.textContent = 'Engelle';
            blockBtn.style.backgroundColor = 'var(--error-red)';
        }
        
        document.getElementById('profile-modal').classList.add('active');
    }

    // --- DATA PANEL ---
    function initDataPanel() {
        const dataPanelPage = document.getElementById('data-panel-page');
        
        // Initialize chart
        const ctx = document.getElementById('data-chart').getContext('2d');
        rpIntervals.chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(15).fill(''),
                datasets: [{
                    label: 'Sinyal Gücü',
                    data: Array(15).fill(50).map(() => Math.random() * 50 + 25),
                    borderColor: 'rgba(0, 238, 255, 1)',
                    backgroundColor: 'rgba(0, 238, 255, 0.2)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: false },
                    y: { 
                        beginAtZero: true,
                        max: 100,
                        display: false
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
        
        // Update chart data periodically
        rpIntervals.chartUpdate = setInterval(() => {
            const chart = rpIntervals.chartInstance;
            if (!chart) return;
            
            chart.data.labels.shift();
            chart.data.labels.push('');
            chart.data.datasets[0].data.shift();
            chart.data.datasets[0].data.push(Math.random() * 50 + 25);
            chart.update('quiet');
        }, 1500);
        
        // Initialize quantum matrix
        const matrix = document.getElementById('quantum-matrix');
        matrix.innerHTML = '';
        for (let i = 0; i < 72; i++) {
            const cell = document.createElement('div');
            cell.className = 'matrix-cell';
            matrix.appendChild(cell);
        }
        
        // Animate matrix cells
        rpIntervals.matrix = setInterval(() => {
            const cells = document.querySelectorAll('.matrix-cell');
            for (let i = 0; i < 3; i++) {
                const r = Math.floor(Math.random() * cells.length);
                cells[r].classList.toggle('active');
            }
        }, 80);
        
        // Initialize core temp gauge
        let temp = 45.0;
        rpIntervals.gauge = setInterval(() => {
            temp += (Math.random() - 0.48) * 3;
            temp = Math.max(20, Math.min(95, temp));
            
            const bar = document.getElementById('core-temp-bar');
            const value = document.getElementById('core-temp-value');
            
            let color;
            if (temp > 85) color = 'var(--error-red)';
            else if (temp > 65) color = 'var(--warning-yellow)';
            else color = 'var(--success-green)';
            
            bar.style.width = `${temp}%`;
            bar.style.backgroundColor = color;
            value.textContent = `${temp.toFixed(1)} °C`;
            value.style.color = color;
        }, 2000);
    }

    function showDataPanelLogin() {
        document.getElementById('data-panel-login-modal').classList.add('active');
    }

    async function handleDataPanelLogin() {
        const accessCodeInput = document.getElementById('access-code-input');
        const statusElement = document.getElementById('data-panel-login-status');
        
        if (Date.now() < dataPanelLockoutUntil) {
            const remaining = Math.ceil((dataPanelLockoutUntil - Date.now()) / 1000);
            statusElement.textContent = `Sistem kilitlendi. Kalan süre: ${remaining} saniye.`;
            statusElement.style.display = 'block';
            return;
        }
        
        if (accessCodeInput.value === ACCESS_CODE) {
            // Successful login
            document.getElementById('data-panel-login-modal').classList.remove('active');
            dataPanelLoginAttempts = 0;
            showPage('data-panel-page');
            accessCodeInput.value = '';
            statusElement.style.display = 'none';
        } else {
            // Failed login
            dataPanelLoginAttempts++;
            accessCodeInput.value = '';
            
            // Show access denied animation
            document.getElementById('access-denied-overlay').classList.add('active');
            document.getElementById('data-panel-login-modal').classList.add('error');
            
            setTimeout(() => {
                document.getElementById('access-denied-overlay').classList.remove('active');
                document.getElementById('data-panel-login-modal').classList.remove('error');
            }, 1500);
            
            if (dataPanelLoginAttempts >= 3) {
                dataPanelLockoutUntil = Date.now() + 5 * 60 * 1000; // 5 minutes lockout
                statusElement.textContent = '3 hatalı giriş. Sistem 5 dakikalığına kilitlendi!';
            } else {
                statusElement.textContent = `Hatalı Erişim Kodu! Kalan deneme: ${3 - dataPanelLoginAttempts}`;
            }
            
            statusElement.style.display = 'block';
        }
    }

    // --- ADMIN PANEL ---
    async function loadUserManagement() {
        if (currentUserRank !== "X-5") return;
        
        const userList = document.getElementById('user-management-list');
        userList.innerHTML = '';
        
        database.ref('users').on('value', (snapshot) => {
            userList.innerHTML = '';
            snapshot.forEach((userSnapshot) => {
                const userData = userSnapshot.val();
                addUserToManagementList(userSnapshot.key, userData);
            });
        });
    }

    function addUserToManagementList(userId, userData) {
        const userItem = document.createElement('li');
        userItem.className = 'user-item';
        
        // Count warnings
        const warningCount = userData.warnings ? Object.keys(userData.warnings).length : 0;
        
        userItem.innerHTML = `
            <div class="user-info">
                <div class="user-name" style="${warningCount >= 3 ? 'color: var(--error-red)' : ''}">${userData.username}</div>
                <div class="user-rank">${userData.rank}</div>
                <div class="user-specialty">${userData.specialty || 'Belirtilmemiş'}</div>
                ${warningCount > 0 ? `<div class="user-warnings">${warningCount} uyarı</div>` : ''}
            </div>
            <div class="user-actions">
                <select class="user-rank-select" data-user-id="${userId}">
                    <option value="X-0" ${userData.rank === 'X-0' ? 'selected' : ''}>X-0</option>
                    <option value="X-1" ${userData.rank === 'X-1' ? 'selected' : ''}>X-1</option>
                    <option value="X-2" ${userData.rank === 'X-2' ? 'selected' : ''}>X-2</option>
                    <option value="X-3" ${userData.rank === 'X-3' ? 'selected' : ''}>X-3</option>
                    <option value="X-4" ${userData.rank === 'X-4' ? 'selected' : ''}>X-4</option>
                    <option value="X-5" ${userData.rank === 'X-5' ? 'selected' : ''}>X-5</option>
                </select>
                <select class="user-specialty-select" data-user-id="${userId}">
                    <option value="Personel" ${userData.specialty === 'Personel' ? 'selected' : ''}>Personel</option>
                    <option value="Teknik" ${userData.specialty === 'Teknik' ? 'selected' : ''}>Teknik</option>
                    <option value="Güvenlik" ${userData.specialty === 'Güvenlik' ? 'selected' : ''}>Güvenlik</option>
                    <option value="Yönetim" ${userData.specialty === 'Yönetim' ? 'selected' : ''}>Yönetim</option>
                    <option value="Analist" ${userData.specialty === 'Analist' ? 'selected' : ''}>Analist</option>
                </select>
                <button class="user-action-btn warn-btn" data-user-id="${userId}">Uyarı</button>
                <button class="user-action-btn ban-btn" data-user-id="${userId}" ${warningCount >= 3 ? 'disabled' : ''}>Yasakla</button>
            </div>
        `;
        document.getElementById('user-management-list').appendChild(userItem);
    }

    async function updateUserRank(userId, newRank) {
        if (currentUserRank !== "X-5") return;
        
        await database.ref(`users/${userId}/rank`).set(newRank);
        showAlert(`Kullanıcı rütbesi güncellendi: ${newRank}`, 'success');
    }

    async function updateUserSpecialty(userId, newSpecialty) {
        if (currentUserRank !== "X-5") return;
        
        await database.ref(`users/${userId}/specialty`).set(newSpecialty);
        showAlert(`Kullanıcı uzmanlığı güncellendi: ${newSpecialty}`, 'success');
    }

    async function warnUser(userId) {
        if (currentUserRank !== "X-5") return;
        
        const reason = prompt('Uyarı sebebini girin:');
        if (reason) {
            await database.ref(`users/${userId}/warnings`).push({
                reason: reason,
                timestamp: Date.now(),
                admin: currentUserId
            });
            showAlert('Kullanıcı uyarıldı', 'warning');
        }
    }

    async function banUser(userId) {
        if (currentUserRank !== "X-5") return;
        
        if (confirm('Bu kullanıcıyı yasaklamak istediğinize emin misiniz?')) {
            await database.ref(`users/${userId}/banned`).set(true);
            showAlert('Kullanıcı yasaklandı', 'error');
        }
    }

    async function loadLatestAnnouncement() {
        const announcementTextarea = document.getElementById('announcement-textarea');
        const snapshot = await database.ref('announcements/latest').once('value');
        if (snapshot.exists()) {
            announcementTextarea.value = snapshot.val().content;
        }
    }

    async function loadLatestAnnouncementForDashboard() {
        const announcementWidget = document.getElementById('latest-announcement-widget');
        const snapshot = await database.ref('announcements/latest').once('value');
        if (snapshot.exists()) {
            announcementWidget.textContent = snapshot.val().content;
        }
    }

    async function publishAnnouncement() {
        if (currentUserRank !== "X-5") return;
        
        const announcementTextarea = document.getElementById('announcement-textarea');
        const content = announcementTextarea.value.trim();
        
        if (!content) return;
        
        await database.ref('announcements/latest').set({
            content: content,
            timestamp: Date.now(),
            author: currentUserId
        });
        
        showAlert('Duyuru yayınlandı!', 'success');
    }

    // --- SETTINGS ---
    function loadSettings() {
        soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
        ttsEnabled = localStorage.getItem('ttsEnabled') === 'true';
        
        document.getElementById('sound-notifications-toggle').checked = soundEnabled;
        document.getElementById('tts-toggle').checked = ttsEnabled;
        document.getElementById('new-username-input').value = currentUserName;
    }

    function saveSettings() {
        soundEnabled = document.getElementById('sound-notifications-toggle').checked;
        ttsEnabled = document.getElementById('tts-toggle').checked;
        
        localStorage.setItem('soundEnabled', soundEnabled);
        localStorage.setItem('ttsEnabled', ttsEnabled);
        
        showAlert('Ayarlar kaydedildi', 'success');
    }

    // --- EVENT LISTENERS ---
    function initializeEventListeners() {
        // Prevent page scrolling from triggering navigation
        document.getElementById('page-content').addEventListener('wheel', (e) => {
            if (e.deltaY !== 0) {
                e.preventDefault();
            }
        });

        // Auth
        document.getElementById('auth-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const loginStatus = document.getElementById('login-status');
            loginStatus.style.display = 'none';
            
            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    await database.ref('users/' + cred.user.uid).set({
                        email: cred.user.email,
                        username: cred.user.email.split('@')[0],
                        specialty: "Yeni Bağlantı",
                        rank: "X-0",
                        online: true,
                        lastSeen: Date.now()
                    });
                }
            } catch (error) {
                loginStatus.textContent = error.message;
                loginStatus.style.display = 'block';
                document.getElementById('login-container').classList.add('error');
                setTimeout(() => document.getElementById('login-container').classList.remove('error'), 500);
            }
        });
        
        document.getElementById('switch-auth-link').addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            document.getElementById('login-title').textContent = isLoginMode ? 'Site-X Erişimi' : 'Yeni Operatör Kaydı';
            document.getElementById('auth-btn').textContent = isLoginMode ? 'BAĞLANTI KUR' : 'KAYIT OL';
            document.getElementById('switch-auth-link').textContent = isLoginMode ? 'Yeni Operatör Kaydı' : 'Mevcut Operatör Girişi';
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            if (currentUserId) {
                database.ref(`users/${currentUserId}`).update({ 
                    online: false,
                    lastSeen: Date.now()
                }).then(() => auth.signOut());
            } else {
                auth.signOut();
            }
        });

        // Navigation
        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(item.dataset.page);
            });
        });

        // Chat
        document.getElementById('send-message-btn').addEventListener('click', sendMessage);
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            const actionBtn = e.target.closest('.message-action-btn');
            const senderName = e.target.closest('.message-sender');
            
            if (actionBtn) {
                const action = actionBtn.dataset.action;
                
                if (action === 'reply') {
                    repliedMessageId = actionBtn.dataset.messageId;
                    repliedMessageText = actionBtn.dataset.messageText;
                    
                    const replyBar = document.createElement('div');
                    replyBar.id = 'reply-to-bar';
                    replyBar.innerHTML = `
                        <span class="reply-to-text">Yanıtlanıyor: ${repliedMessageText}</span>
                        <button class="cancel-reply-btn" id="cancel-reply-btn">×</button>
                    `;
                    
                    const existingBar = document.getElementById('reply-to-bar');
                    if (existingBar) existingBar.remove();
                    
                    document.getElementById('chat-input-container').insertBefore(replyBar, document.getElementById('chat-input'));
                    
                    document.getElementById('cancel-reply-btn').addEventListener('click', () => {
                        repliedMessageId = null;
                        repliedMessageText = null;
                        replyBar.remove();
                    });
                } else if (action === 'pm') {
                    openPrivateChat(actionBtn.dataset.userId, actionBtn.dataset.userName);
                } else if (action === 'delete') {
                    deleteMessage(actionBtn.dataset.messageId);
                }
            } else if (senderName) {
                const userId = senderName.dataset.userId;
                showProfile(userId);
            }
        });

        // Friends
        document.getElementById('friends-list').addEventListener('click', (e) => {
            const pmBtn = e.target.closest('.pm-btn');
            const removeBtn = e.target.closest('.remove-btn');
            const friendName = e.target.closest('.friend-name');
            
            if (pmBtn) {
                openPrivateChat(pmBtn.dataset.userId, pmBtn.dataset.userName);
            } else if (removeBtn) {
                const friendId = removeBtn.dataset.userId;
                if (confirm('Bu bağlantıyı kaldırmak istediğinize emin misiniz?')) {
                    removeFriend(friendId);
                }
            } else if (friendName) {
                const userId = friendName.dataset.userId;
                showProfile(userId);
            }
        });
        
        document.getElementById('friend-requests-list').addEventListener('click', (e) => {
            const acceptBtn = e.target.closest('.accept-btn');
            const rejectBtn = e.target.closest('.reject-btn');
            const requesterName = e.target.closest('.friend-name');
            
            if (acceptBtn) {
                acceptFriendRequest(acceptBtn.dataset.userId);
            } else if (rejectBtn) {
                rejectFriendRequest(rejectBtn.dataset.userId);
            } else if (requesterName) {
                const userId = requesterName.dataset.userId;
                showProfile(userId);
            }
        });

        // Private Chat
        document.getElementById('send-private-message-btn').addEventListener('click', sendPrivateMessage);
        document.getElementById('private-chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendPrivateMessage();
        });
        
        document.getElementById('private-chat-close').addEventListener('click', () => {
            document.getElementById('private-chat-modal').classList.remove('active');
            currentPrivateChatUserId = null;
        });

        // Data Panel
        document.querySelector('.nav-item[data-page="data-panel-page"]').addEventListener('click', (e) => {
            e.preventDefault();
            showDataPanelLogin();
        });
        
        document.getElementById('data-panel-login-btn').addEventListener('click', handleDataPanelLogin);
        document.getElementById('access-code-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleDataPanelLogin();
        });
        
        document.getElementById('data-panel-login-close').addEventListener('click', () => {
            document.getElementById('data-panel-login-modal').classList.remove('active');
        });

        // Admin Panel
        document.getElementById('user-management-list').addEventListener('change', (e) => {
            const rankSelect = e.target.closest('.user-rank-select');
            const specialtySelect = e.target.closest('.user-specialty-select');
            
            if (rankSelect) {
                updateUserRank(rankSelect.dataset.userId, rankSelect.value);
            } else if (specialtySelect) {
                updateUserSpecialty(specialtySelect.dataset.userId, specialtySelect.value);
            }
        });
        
        document.getElementById('user-management-list').addEventListener('click', (e) => {
            const warnBtn = e.target.closest('.warn-btn');
            const banBtn = e.target.closest('.ban-btn');
            
            if (warnBtn) {
                warnUser(warnBtn.dataset.userId);
            } else if (banBtn) {
                banUser(banBtn.dataset.userId);
            }
        });
        
        document.getElementById('publish-announcement-btn').addEventListener('click', publishAnnouncement);

        // Profile Modal
        document.getElementById('profile-pm-btn').addEventListener('click', () => {
            const name = document.getElementById('profile-name').textContent;
            openPrivateChat(currentProfileUserId, name);
            document.getElementById('profile-modal').classList.remove('active');
        });
        
        document.getElementById('profile-add-friend-btn').addEventListener('click', async () => {
            const btn = document.getElementById('profile-add-friend-btn');
            const isFriend = btn.textContent === 'Bağlantıyı Kaldır';
            
            if (isFriend) {
                await removeFriend(currentProfileUserId);
                btn.textContent = 'Bağlantı Ekle';
                btn.style.backgroundColor = 'var(--success-green)';
            } else {
                await sendFriendRequest(currentProfileUserId);
            }
        });
        
        document.getElementById('profile-block-btn').addEventListener('click', () => {
            showAlert('Kullanıcı engellendi', 'warning');
            document.getElementById('profile-modal').classList.remove('active');
        });
        
        document.getElementById('profile-close').addEventListener('click', () => {
            document.getElementById('profile-modal').classList.remove('active');
        });

        // Settings Modal
        document.getElementById('user-avatar').addEventListener('click', () => {
            document.getElementById('settings-modal').classList.add('active');
            loadSettings();
        });
        
        document.getElementById('settings-close').addEventListener('click', () => {
            saveSettings();
            document.getElementById('settings-modal').classList.remove('active');
        });
        
        document.getElementById('change-username-btn').addEventListener('click', () => {
            const newUsername = document.getElementById('new-username-input').value.trim();
            changeUsername(newUsername);
        });
        
        document.getElementById('new-username-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const newUsername = e.target.value.trim();
                changeUsername(newUsername);
            }
        });

        // Global Command Line
        document.getElementById('command-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const command = e.target.value.trim();
                if (command) {
                    if (command === '/help') {
                        showAlert('Kullanılabilir komutlar: /online, /profile, /protokol-a, /protokol-x', 'info');
                    } else if (command === '/clear') {
                        document.getElementById('chat-messages').innerHTML = '';
                        showAlert('Sohbet temizlendi', 'success');
                    } else if (command === '/online') {
                        database.ref('users').orderByChild('online').equalTo(true).once('value').then((snapshot) => {
                            const count = snapshot.numChildren();
                            showAlert(`Çevrimiçi kullanıcılar: ${count}`, 'info');
                        });
                    } else if (command === '/profile') {
                        showAlert(`Profil bilgisi: ${currentUserName} (${currentUserRank})`, 'info');
                    } else if (command === '/protokol-a') {
                        showAlert('İçerik Silindi', 'error');
                    } else if (command === '/protokol-x') {
                        showAlert('Erişim seviyeniz yetersiz', 'warning');
                    } else {
                        showAlert('Geçersiz komut. /help yazarak kullanılabilir komutları görebilirsiniz.', 'error');
                    }
                    e.target.value = '';
                }
            }
        });
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Background animation
        const bg = document.getElementById('background-animation');
        for (let i = 0; i < 15; i++) {
            const hex = document.createElement('div');
            hex.className = 'hexagon';
            hex.style.left = `${Math.random() * 100}vw`;
            hex.style.animationDuration = `${Math.random() * 20 + 15}s`;
            hex.style.animationDelay = `${Math.random() * 5}s`;
            bg.appendChild(hex);
        }
        
        // Initialize event listeners
        initializeEventListeners();
    });
</script>
</body>
</html>
